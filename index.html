<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
<title>âœˆ ROGER ê´€ê·¹ ë‹¤ì´ì–´ë¦¬</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3B6FE8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ROGER">
<style>
  :root {
    --bg: #f8f8f6; --bg2: #ffffff; --bg3: #f0f0ee;
    --border: #e0e0dc; --text: #1a1a1a; --text2: #555550; --text3: #999990;
    --accent: #2a5caa; --accent2: #1a3c7a; --accent-light: #e8eef8;
    --danger: #cc4444; --success: #2a8a4a; --star: #f0a020;
    --seat1: #dce8f8; --seat2: #a8c4ee; --seat3: #6a9ad8; --seat4: #3a6ab8; --seat5: #1a3a88;
    --shadow: 0 2px 12px rgba(0,0,0,0.08); --radius: 12px; --tab-h: 64px;
  }
  [data-theme="dark"] {
    --bg: #111118; --bg2: #1a1a24; --bg3: #22222e;
    --border: #333340; --text: #f0f0f0; --text2: #aaaaaa; --text3: #666670;
    --accent: #5a8cdd; --accent2: #7aacff; --accent-light: #1a2a44;
    --danger: #ee6666; --success: #44aa66;
    --shadow: 0 2px 12px rgba(0,0,0,0.4);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
    background: var(--bg); color: var(--text);
    max-width: 480px; margin: 0 auto; min-height: 100vh;
  }
  #app { padding-bottom: calc(var(--tab-h) + env(safe-area-inset-bottom, 0px)); }

  /* TAB BAR */
  .tab-bar {
    position: fixed; bottom: 0; left: 0;
    width: 100%;
    height: calc(var(--tab-h) + env(safe-area-inset-bottom, 0px));
    padding-bottom: env(safe-area-inset-bottom, 0px);
    padding-left: env(safe-area-inset-left, 0px);
    padding-right: env(safe-area-inset-right, 0px);
    background: var(--bg2); border-top: 1px solid var(--border);
    display: flex; z-index: 100; box-sizing: border-box;
  }
  .tab-btn {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 3px;
    background: none; border: none; cursor: pointer;
    color: var(--text3); font-size: 10px; transition: color 0.2s;
  }
  .tab-btn.active { color: var(--accent); }
  .tab-btn .icon { font-size: 20px; }

  /* PAGES */
  .page { display: none; padding: 16px 16px 8px; }
  .page.active { display: block; }

  /* HEADER */
  .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .page-title { font-size: 22px; font-weight: 700; }

  /* CARD */
  .card {
    background: var(--bg2); border-radius: var(--radius);
    padding: 16px; margin-bottom: 12px;
    box-shadow: var(--shadow); border: 1px solid var(--border);
  }
  .card-title { font-size: 13px; color: var(--text3); margin-bottom: 8px; font-weight: 500; }

  /* BUTTONS */
  .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; transition: opacity 0.2s; }
  .btn:active { opacity: 0.7; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-outline { background: none; border: 1.5px solid var(--border); color: var(--text); }
  .btn-danger { background: var(--danger); color: #fff; }
  .btn-sm { padding: 6px 14px; font-size: 12px; }
  .btn-icon { width: 32px; height: 32px; border-radius: 8px; background: var(--bg3); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }

  /* FORM */
  .form-group { margin-bottom: 14px; }
  .form-label { font-size: 12px; color: var(--text2); margin-bottom: 5px; display: block; font-weight: 500; }
  .form-control {
    width: 100%; padding: 10px 12px; border: 1.5px solid var(--border);
    border-radius: 8px; background: var(--bg); color: var(--text);
    font-size: 14px; outline: none; transition: border-color 0.2s;
  }
  .form-control:focus { border-color: var(--accent); }
  .form-row { display: flex; gap: 10px; }
  .form-row .form-group { flex: 1; }
  textarea.form-control { min-height: 80px; resize: vertical; }

  /* STAR */
  .star-group { display: flex; gap: 6px; }
  .star-btn { font-size: 24px; background: none; border: none; cursor: pointer; transition: transform 0.1s; }
  .star-btn:active { transform: scale(1.3); }

  /* OVERLAY / PANEL */
  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
  .overlay.open { display: flex; }
  .panel { background: var(--bg2); border-radius: 20px 20px 0 0; width: 100%; max-width: 480px; max-height: 92vh; overflow-y: auto; padding: 20px 20px 40px; animation: slideUp 0.25s ease; }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .panel-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 20px; }
  .panel-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }

  /* TOGGLE */
  .toggle { width: 48px; height: 26px; background: var(--border); border-radius: 13px; position: relative; cursor: pointer; border: none; transition: background 0.2s; }
  .toggle.on { background: var(--accent); }
  .toggle::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: transform 0.2s; }
  .toggle.on::after { transform: translateX(22px); }

  /* RECORD LIST */
  .record-mini { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); cursor: pointer; gap: 10px; }
  .record-mini:last-child { border-bottom: none; }
  .record-date-badge { background: var(--accent-light); color: var(--accent); border-radius: 8px; padding: 6px 10px; font-size: 12px; font-weight: 600; min-width: 60px; text-align: center; }
  .record-casting { font-size: 13px; font-weight: 500; flex: 1; }
  .record-rating { color: var(--star); font-size: 12px; }

  /* CALENDAR */
  .cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .cal-month { font-size: 18px; font-weight: 700; }
  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
  .cal-dow { text-align: center; font-size: 11px; color: var(--text3); padding: 6px 0; font-weight: 600; }
  .cal-week-wrap { position: relative; }
  .cal-event-overlay { position: absolute; top: 0; left: 0; right: 0; pointer-events: none; z-index: 1; }
  .cal-event-row { position: relative; height: 16px; margin-bottom: 1px; }
  .cal-event-bar-full {
    position: absolute; height: 14px; border-radius: 3px; top: 1px;
    display: flex; align-items: center; padding: 0 4px;
    font-size: 9px; font-weight: 600; color: #fff;
    overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
  }
  .cal-day { min-height: 42px; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start; padding: 4px 3px 3px; border-radius: 6px; cursor: pointer; position: relative; transition: background 0.15s; overflow: hidden; }
  .cal-day:hover { background: var(--bg3); }
  .cal-day.today { background: var(--accent-light); font-weight: 700; color: var(--accent); }
  .cal-day.selected { outline: 2px solid var(--accent); }
  .cal-day.empty { cursor: default; }
  .cal-day.sun { color: #cc4444; }
  .cal-day.sat { color: var(--accent); }
  .cal-day-num { font-size: 12px; line-height: 1.3; font-weight: 500; width: 100%; text-align: center; }
  .cal-session-chip { display: flex; align-items: center; gap: 2px; font-size: 9px; line-height: 1.4; width: 100%; margin-top: 2px; }
  .cal-session-chip .cs-icon { font-size: 7px; flex-shrink: 0; }
  .cal-session-chip .cs-time { color: var(--text2); flex-shrink: 0; font-weight: 600; }
  .cal-session-chip.booked .cs-time { color: var(--success); font-weight: 700; }
  .cal-session-chip.done .cs-time { color: var(--accent); font-weight: 700; }
  .cal-session-chip.done .cs-icon { color: var(--accent); font-size: 9px; font-weight: 900; }
  /* ìº˜ë¦°ë” í•„í„° */
  .cal-filter { margin-bottom: 10px; }
  .cal-filter-row { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; flex-wrap: wrap; }
  .cal-filter-label { font-size: 11px; color: var(--text3); font-weight: 600; min-width: 36px; }
  .cal-chip { padding: 3px 9px; border-radius: 12px; font-size: 11px; border: 1px solid var(--border); background: var(--bg2); color: var(--text2); cursor: pointer; white-space: nowrap; }
  .cal-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  /* ë‚ ì§œ í´ë¦­ íŒ¨ë„ */
  .cal-day-panel { background: var(--bg1); border-radius: var(--radius); border: 1px solid var(--border); margin-top: 8px; overflow: hidden; }
  .cal-day-panel-title { font-size: 14px; font-weight: 700; padding: 12px 14px 8px; }
  .cal-session-row { display: flex; align-items: center; gap: 8px; padding: 9px 14px; border-top: 1px solid var(--border); }
  .cal-session-time { font-size: 12px; font-weight: 700; color: var(--text2); min-width: 36px; }
  .cal-session-casting { flex: 1; font-size: 13px; }
  .cal-session-casting .sky { color: #1a3a88; font-weight: 600; }
  .cal-session-casting .didi { color: #881a3a; font-weight: 600; }
  [data-theme="dark"] .cal-session-casting .sky { color: #7aacff; }
  [data-theme="dark"] .cal-session-casting .didi { color: #ff7aac; }
  .cal-session-badge { font-size: 10px; padding: 2px 7px; border-radius: 8px; font-weight: 600; white-space: nowrap; }
  .cal-session-badge.done   { background: var(--accent-light); color: var(--accent); }
  .cal-session-badge.booked { background: #e6f9ee; color: var(--success); }
  [data-theme="dark"] .cal-session-badge.booked { background: #1a3a26; }
  .cal-session-add { font-size: 11px; padding: 4px 9px; border-radius: 7px; border: 1px solid var(--accent); color: var(--accent); background: none; cursor: pointer; white-space: nowrap; }

  /* STATS */
  .stats-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .stats-table th { text-align: left; color: var(--text3); font-weight: 500; padding: 6px 8px; border-bottom: 1px solid var(--border); }
  .stats-table td { padding: 8px 8px; border-bottom: 1px solid var(--border); }
  .stats-table td:last-child { text-align: right; font-weight: 700; color: var(--accent); }
  .role-section-title { font-size: 12px; font-weight: 700; color: var(--text3); padding: 6px 8px 2px; }

  /* HEATMAP */
  .heatmap-wrap { display: flex; gap: 8px; justify-content: center; overflow-x: auto; padding: 8px 0; }
  .zone-wrap { display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; }
  .zone-label { font-size: 11px; font-weight: 700; color: var(--text3); }
  .seat-grid { display: flex; flex-direction: column; gap: 2px; }
  .seat-row { display: flex; gap: 2px; align-items: center; }
  .row-label { font-size: 9px; color: var(--text3); width: 28px; text-align: right; margin-right: 2px; white-space: nowrap; }
  .seat-cell { width: 16px; height: 16px; border-radius: 3px; background: var(--bg3); border: 1px solid var(--border); transition: background 0.2s; flex-shrink: 0; }
  .seat-cell.v1 { background: var(--seat1); border-color: var(--seat1); }
  .seat-cell.v2 { background: var(--seat2); border-color: var(--seat2); }
  .seat-cell.v3 { background: var(--seat3); border-color: var(--seat3); }
  .seat-cell.v4 { background: var(--seat4); border-color: var(--seat4); }
  .seat-cell.v5 { background: var(--seat5); border-color: var(--seat5); }
  .heatmap-legend { display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text2); }
  .legend-dot { width: 14px; height: 14px; border-radius: 3px; }

  /* MINI SEAT */
  .mini-heatmap { display: flex; gap: 6px; justify-content: center; margin: 8px 0; overflow-x: auto; }
  .mini-zone { display: flex; flex-direction: column; gap: 1px; align-items: center; }
  .mini-zone-label { font-size: 9px; color: var(--text3); margin-bottom: 2px; }
  .mini-seat-row { display: flex; gap: 1px; }
  .mini-seat-cell { width: 10px; height: 10px; border-radius: 1px; background: var(--bg3); border: 1px solid var(--border); }
  .mini-seat-cell.highlight { background: var(--accent); border-color: var(--accent); }

  /* STATS MONEY BLUR */
  .money-blur-wrap { transition: filter 0.3s; }
  .money-blur-wrap.blurred { filter: blur(6px); user-select: none; pointer-events: none; }

  /* SCHEDULE */
  .schedule-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .schedule-table th { text-align: left; padding: 8px; border-bottom: 2px solid var(--border); color: var(--text3); font-weight: 600; font-size: 12px; }
  .schedule-table td { padding: 9px 8px; border-bottom: 1px solid var(--border); }
  .schedule-row.past { opacity: 0.45; }
  .schedule-row.today-row { background: var(--accent-light); }
  .time-badge { font-size: 11px; background: var(--bg3); padding: 2px 6px; border-radius: 4px; color: var(--text2); }
  .actor-pill { display: inline-block; font-size: 12px; padding: 2px 8px; border-radius: 12px; font-weight: 500; }
  .actor-pill.sky { background: #e0eeff; color: #2255aa; }
  .actor-pill.didi { background: #ffe0f0; color: #aa2255; }
  [data-theme="dark"] .actor-pill.sky { background: #1a2a44; color: #7aacff; }
  [data-theme="dark"] .actor-pill.didi { background: #3a1a2a; color: #ff7aac; }

  /* STAMP / COUPON */
  .stamp-cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .stamp-board { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; transition: opacity 0.2s; }
  .stamp-board.paused { opacity: 0.45; }
  .stamp-board-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .stamp-board-name { font-weight: 700; font-size: 14px; flex: 1; min-width: 0; }
  .stamp-board-menu { display: flex; gap: 3px; align-items: center; flex-shrink: 0; margin-left: 4px; }
  .stamp-menu-btn { width: 24px; height: 24px; border-radius: 6px; background: var(--bg3); border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 11px; color: var(--text2); line-height: 1; }
  .stamp-menu-btn.danger { color: var(--danger); }
  .stamp-progress-wrap { margin: 6px 0 4px; }
  .stamp-count-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
  .stamp-count-cur { font-size: 13px; font-weight: 700; color: var(--accent); }
  .stamp-count-final { font-size: 11px; color: var(--text3); }
  .progress-bar { width: 100%; height: 12px; background: var(--bg3); border-radius: 6px; overflow: visible; position: relative; }
  .progress-fill { height: 100%; background: var(--accent); border-radius: 6px; transition: width 0.4s ease; }
  .progress-marker { position: absolute; top: -3px; width: 2px; height: 18px; background: var(--star); border-radius: 1px; }
  .stamp-status-row { font-size: 11px; margin-top: 5px; min-height: 16px; }
  .stamp-status-mid  { color: #e06000; font-weight: 600; }
  .stamp-status-done { color: var(--star); font-weight: 700; }
  .stamp-status-next { color: var(--text3); }
  .stamp-status-paused { color: var(--text3); font-style: italic; }
  .stamp-actions { margin-top: 8px; display: flex; flex-direction: column; gap: 5px; }
  .stamp-history-btn { width: 100%; padding: 6px; border-radius: 7px; background: var(--bg3); border: 1px solid var(--border); cursor: pointer; font-size: 12px; color: var(--text2); font-weight: 500; text-align: center; }

  /* ì¿ í° ê°€ë¡œ ì¹´ë“œ */
  .coupon-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .coupon-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 6px; text-align: center; }
  .coupon-card-label { font-size: 11px; color: var(--text2); font-weight: 600; height: 28px; display: flex; align-items: center; justify-content: center; line-height: 1.3; margin-bottom: 6px; }
  .coupon-card-sub-row { display: flex; margin-bottom: 3px; }
  .coupon-card-sub { flex: 1; font-size: 10px; color: var(--text3); text-align: center; }
  .coupon-card-sub + .coupon-card-sub { border-left: 1px solid var(--border); }
  .coupon-card-num-row { display: flex; }
  .coupon-card-num { flex: 1; font-size: 22px; font-weight: 700; color: var(--success); line-height: 1; text-align: center; }
  .coupon-card-num.final { color: var(--text3); font-size: 22px; border-left: 1px solid var(--border); }
  /* ì´ë ¥ í‘œ */
  .coupon-hist-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .coupon-hist-table th { padding: 5px 4px; border-bottom: 2px solid var(--border); color: var(--text2); font-weight: 600; text-align: center; }
  .coupon-hist-table td { padding: 0 3px; height: 28px; border-bottom: 1px solid var(--border); text-align: center; vertical-align: middle; white-space: nowrap; }
  .coupon-hist-table tr:last-child td { border-bottom: none; }
  .hist-type-get  { color: var(--success); font-weight: 700; }
  .hist-type-use  { color: var(--danger);  font-weight: 700; }
  .hist-type-restore { color: var(--text2); font-weight: 600; }
  .hist-delta-pos { color: var(--success); font-weight: 700; }
  .hist-delta-neg { color: var(--danger);  font-weight: 700; }
  .hist-del-btn { background: none; border: none; cursor: pointer; color: var(--danger); font-size: 11px; padding: 1px 3px; opacity: 0.65; }
  .hist-milestone-badge { display: inline-block; font-size: 10px; color: var(--accent); background: var(--accent-light); border-radius: 4px; padding: 1px 5px; margin-left: 4px; }

  .history-list { margin-top: 8px; }
  .history-item { font-size: 12px; color: var(--text2); padding: 6px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
  .history-item:last-child { border-bottom: none; }
  .history-type { color: var(--text3); white-space: nowrap; }
  .history-comment { color: var(--text3); font-size: 11px; margin-top: 2px; }

  /* SETTINGS */
  .setting-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border); }
  .setting-item:last-child { border-bottom: none; }
  .setting-label { font-size: 15px; font-weight: 500; }

  /* MISC */
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text3); }
  .empty-state .emoji { font-size: 40px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }
  .toast { position: fixed; bottom: calc(var(--tab-h) + 16px); left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 300; opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap; }
  .toast.show { opacity: 1; }
  .divider { height: 1px; background: var(--border); margin: 12px 0; }
  .section-title { font-size: 14px; font-weight: 700; margin-bottom: 10px; color: var(--text2); }
  .flex-between { display: flex; justify-content: space-between; align-items: center; }
  .collapsible { display: none; }
  .collapsible.open { display: block; }

  /* DETAIL */
  .detail-field { margin-bottom: 12px; }
  .detail-field-label { font-size: 11px; color: var(--text3); margin-bottom: 3px; }
  .detail-field-value { font-size: 15px; font-weight: 500; }
  .casting-display { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
  .casting-tag { padding: 6px 14px; border-radius: 20px; font-size: 14px; font-weight: 600; }
  .casting-tag.sky { background: #e0eeff; color: #1a3a88; }
  .casting-tag.didi { background: #ffe0f0; color: #881a3a; }
  [data-theme="dark"] .casting-tag.sky { background: #1a2a44; color: #7aacff; }
  [data-theme="dark"] .casting-tag.didi { background: #3a1a2a; color: #ff7aac; }

  /* HOME */
  .next-show-card { background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%); border-radius: var(--radius); padding: 18px; margin-bottom: 8px; color: #fff; position: relative; overflow: hidden; cursor: pointer; }
  .next-show-card::before { content: 'âœˆ'; position: absolute; right: 16px; top: 12px; font-size: 40px; opacity: 0.15; }
  .next-show-dday { font-size: 32px; font-weight: 900; letter-spacing: -1px; margin-bottom: 4px; }
  .next-show-dday.today-dday { color: #ffe066; }
  .next-show-date { font-size: 13px; opacity: 0.85; margin-bottom: 10px; }
  .next-show-casting { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
  .next-show-pill { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
  .next-show-pill.sky { background: rgba(255,255,255,0.25); }
  .next-show-pill.didi { background: rgba(255,200,220,0.3); }
  .next-show-seat { font-size: 12px; opacity: 0.75; }

  .upcoming-item { display: flex; align-items: center; padding: 9px 0; border-bottom: 1px solid var(--border); cursor: pointer; gap: 10px; }
  .upcoming-item:last-child { border-bottom: none; }
  .upcoming-dday { font-size: 12px; font-weight: 700; color: var(--accent); min-width: 36px; }
  .upcoming-date { font-size: 12px; color: var(--text2); flex: 1; }
  .upcoming-cast { font-size: 12px; color: var(--text3); }

  .home-stamp-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .home-stamp-row:last-child { border-bottom: none; }
  .home-stamp-name { font-size: 13px; font-weight: 600; min-width: 70px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .home-stamp-bar { flex: 2; height: 6px; background: var(--bg3); border-radius: 3px; overflow: hidden; }
  .home-stamp-bar-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.4s; }
  .home-stamp-count { font-size: 12px; color: var(--text3); min-width: 40px; text-align: right; }

  .home-coupon-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .home-coupon-row:last-child { border-bottom: none; }
  .home-coupon-name { font-size: 13px; color: var(--text2); }
  .home-coupon-count { font-size: 18px; font-weight: 700; color: var(--accent); }

  /* SCHEDULE FILTER CHIPS */
  .filter-wrap  { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; margin-bottom: 12px; }
  .filter-row   { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .filter-row:last-child { margin-bottom: 0; }
  .filter-label { font-size: 11px; color: var(--text3); font-weight: 600; min-width: 40px; flex-shrink: 0; }
  .filter-chips { display: flex; gap: 6px; flex-wrap: wrap; }
  .chip { padding: 4px 12px; border-radius: 20px; border: 1.5px solid var(--border); background: var(--bg3); color: var(--text2); font-size: 12px; cursor: pointer; transition: all 0.15s; }
  .chip.active  { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* SCHEDULE BADGES */
  .badge { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px; font-weight: 600; }
  .badge-done   { background: var(--accent-light); color: var(--accent); }
  .badge-booked { background: #e8f5e9; color: var(--success); }
  [data-theme="dark"] .badge-booked { background: #1a3a2a; color: var(--success); }

  /* SCHEDULE CHECK COLUMN (I5) */
  .schedule-check { width: 28px; text-align: center; padding: 0 4px !important; }
  .check-done   { display:inline-flex; width:20px; height:20px; border-radius:50%; background:var(--accent); color:#fff; align-items:center; justify-content:center; font-size:11px; font-weight:700; }
  .check-booked { display:inline-flex; width:20px; height:20px; border-radius:50%; background:transparent; color:var(--success); align-items:center; justify-content:center; font-size:13px; border:1.5px solid var(--success); }

  /* CALENDAR DOTS & EVENTS */
  /* cal-day styles defined above */

  /* CALENDAR EVENT LAYER (I4) */
  

  /* ACTOR PHOTO SETTINGS */
  
  .actor-thumb { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
  .actor-init-thumb { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-light); color: var(--accent); font-size: 13px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .actor-name-label { flex: 1; font-size: 14px; font-weight: 500; }
  .actor-role-tag { font-size: 10px; color: var(--text3); }
</style>
</head>
<body>
<div id="app">

<!-- ========== HOME ========== -->
<div class="page active" id="page-home">
  <div class="page-header">
    <div class="page-title">âœˆ ROGER</div>
    <button class="btn btn-primary btn-sm" onclick="openAddRecord()">+ ê¸°ë¡</button>
  </div>
  <div id="home-next-show"></div>
  <div class="card" id="home-upcoming-card" style="margin-bottom:12px;display:none;">
    <div class="card-title">ğŸ“‹ ì˜ˆì • ì¼ì •</div>
    <div id="home-upcoming"></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“¡ êµì‹ ì¼ì§€ í˜„í™©</div>
    <div id="home-stamps"></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸŸ ì¿ í° ì”ì—¬</div>
    <div id="home-coupons"></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“‹ ìµœê·¼ ê´€ëŒ</div>
    <div id="home-recent"></div>
  </div>
</div>

<!-- ========== CALENDAR ========== -->
<div class="page" id="page-calendar">
  <div class="page-header">
    <div class="page-title">ğŸ“… ìº˜ë¦°ë”</div>
    <button class="btn btn-primary btn-sm" onclick="openAddRecord()">+ ê¸°ë¡</button>
  </div>
  <!-- ë°°ìš° í•„í„° -->
  <div class="cal-filter">
    <div class="cal-filter-row">
      <span class="cal-filter-label">ìŠ¤ì¹´ì¼ëŸ¬</span>
      <div id="cal-chips-sky" style="display:flex;gap:6px;flex-wrap:wrap;">
        <button class="cal-chip active" onclick="setCalFilterSky(null,this)">ì „ì²´</button>
        <button class="cal-chip" onclick="setCalFilterSky('ì£¼ë¯¼ì§„',this)">ì£¼ë¯¼ì§„</button>
        <button class="cal-chip" onclick="setCalFilterSky('ê³ ìƒí˜¸',this)">ê³ ìƒí˜¸</button>
        <button class="cal-chip" onclick="setCalFilterSky('ê¸°ì„¸ì¤‘',this)">ê¸°ì„¸ì¤‘</button>
      </div>
    </div>
    <div class="cal-filter-row">
      <span class="cal-filter-label">ë””ë””</span>
      <div id="cal-chips-didi" style="display:flex;gap:6px;flex-wrap:wrap;">
        <button class="cal-chip active" onclick="setCalFilterDidi(null,this)">ì „ì²´</button>
        <button class="cal-chip" onclick="setCalFilterDidi('ì •íœ˜',this)">ì •íœ˜</button>
        <button class="cal-chip" onclick="setCalFilterDidi('ì´í•œì†”',this)">ì´í•œì†”</button>
        <button class="cal-chip" onclick="setCalFilterDidi('ë°•ì£¼í˜',this)">ë°•ì£¼í˜</button>
      </div>
    </div>
    <div id="cal-filter-hint" style="font-size:11px;color:var(--text3);padding:2px 0 4px;">ë°°ìš°ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ íšŒì°¨ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
  </div>
  <div class="card" style="padding:12px;">
    <div class="cal-nav">
      <button class="btn-icon" onclick="calPrev()">â€¹</button>
      <div class="cal-month" id="cal-title"></div>
      <button class="btn-icon" onclick="calNext()">â€º</button>
    </div>
    <div id="cal-wrap"></div>
  </div>
  <div id="cal-day-records"></div>
</div>

<!-- ========== COUPON / STAMP ========== -->
<div class="page" id="page-coupon">
  <div class="page-header">
    <div class="page-title">ğŸ« ì¿ í°Â·ë„ì¥</div>
    <button class="btn btn-outline btn-sm" onclick="openAddStampBoard()">+ ë„ì¥íŒ</button>
  </div>

  <!-- êµì‹ ì¼ì§€ ì¹´ë“œ -->
  <div class="section-title" style="margin-bottom:8px;">êµì‹ ì¼ì§€ ì¹´ë“œ</div>
  <div id="stamp-boards-list" style="margin-bottom:16px;"></div>

  <!-- í• ì¸ê¶Œ ì§€ê°‘ -->
  <div class="card" style="margin-bottom:16px;">
    <div class="flex-between" style="margin-bottom:12px;">
      <div class="card-title" style="margin:0;">ğŸ‘› í• ì¸ê¶Œ ì§€ê°‘</div>
      <button class="btn btn-primary btn-sm" onclick="openAddCouponManual()">+ í• ì¸ê¶Œ ì¶”ê°€/ì°¨ê°</button>
    </div>
    <div id="coupon-list"></div>
    <div style="margin-top:10px;">
      <button class="btn btn-outline btn-sm" style="width:100%;" onclick="openAddCouponPack()">ğŸ ì¿ í°íŒ© ì¶”ê°€ (3ì¢… +1)</button>
    </div>
  </div>

  <!-- ì „ì²´ ì´ë ¥ í‘œ -->
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title">í• ì¸ê¶Œ ìƒì„¸ ê¸°ë¡</div>
    <div id="coupon-all-history"></div>
  </div>
</div>

<!-- ========== STATS ========== -->
<div class="page" id="page-stats">
  <div class="page-header"><div class="page-title">ğŸ˜Œ í†µê³„</div></div>
  <div class="card">
    <div class="card-title">ğŸ­ ë°°ìš°ë³„ ê´€ëŒ íšŸìˆ˜</div>
    <table class="stats-table" id="stats-actors"></table>
  </div>
  <div class="card">
    <div class="card-title">ğŸ”— í˜ì–´ ì¡°í•©ë³„</div>
    <table class="stats-table" id="stats-pairs"></table>
  </div>
  <div class="card">
    <div class="card-title">ğŸ’º ì¢Œì„ íˆíŠ¸ë§µ</div>
    <div class="heatmap-wrap" id="heatmap"></div>
    <div class="heatmap-legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--bg3);border:1px solid var(--border)"></div>0íšŒ</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--seat1)"></div>1íšŒ</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--seat2)"></div>2íšŒ</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--seat3)"></div>3íšŒ</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--seat4)"></div>4íšŒ</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--seat5)"></div>5íšŒ+</div>
    </div>
  </div>
  <div class="card">
    <div class="flex-between" style="margin-bottom:8px;">
      <div class="card-title" style="margin:0;">ğŸ’° ì§€ì¶œ í˜„í™©</div>
      <button class="btn btn-outline btn-sm" id="money-reveal-btn" onclick="toggleMoneyBlur()">ğŸ‘ğŸ‘</button>
    </div>
    <div class="money-blur-wrap blurred" id="money-blur">
      <div id="stats-money"></div>
    </div>
  </div>
</div>

<!-- ========== SETTINGS ========== -->
<div class="page" id="page-settings">
  <div class="page-header"><div class="page-title">âš™ï¸ ì„¤ì •</div></div>
  <div class="card">
    <div class="setting-item">
      <div class="setting-label">ë‹¤í¬ëª¨ë“œ</div>
      <button class="toggle" id="dark-toggle" onclick="toggleDark()"></button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“‹ ìŠ¤ì¼€ì¤„</div>
    <div class="setting-item">
      <div>
        <div class="setting-label" style="font-size:14px;">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
        <div id="schedule-update-time" style="font-size:12px;color:var(--text3);margin-top:2px;">í™•ì¸ ì¤‘...</div>
      </div>
      <button class="btn btn-outline btn-sm" onclick="fetchSchedule(true)">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div id="schedule-fetch-status" style="font-size:12px;color:var(--text3);margin-top:6px;"></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸª ì´ë²¤íŠ¸</div>
    <div class="setting-item">
      <div>
        <div class="setting-label" style="font-size:14px;">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
        <div id="event-update-time" style="font-size:12px;color:var(--text3);margin-top:2px;">í™•ì¸ ì¤‘...</div>
      </div>
      <button class="btn btn-outline btn-sm" onclick="fetchEvents(true)">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div id="event-fetch-status" style="font-size:12px;color:var(--text3);margin-top:6px;"></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ’¾ ë°ì´í„° ë°±ì—…/ë³µì›</div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-outline" style="flex:1;" onclick="exportData()">JSON ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn btn-outline" style="flex:1;" onclick="document.getElementById('import-file').click()">JSON ê°€ì ¸ì˜¤ê¸°</button>
    </div>
    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
  </div>
  <div class="card">
    <div class="card-title">ğŸ“± í™ˆìŠ¤í¬ë¦° ì¶”ê°€ (PWA)</div>
    <p style="font-size:13px;color:var(--text2);">ë¸Œë¼ìš°ì € ë©”ë‰´ â†’ "í™ˆ í™”ë©´ì— ì¶”ê°€"ë¥¼ ì„ íƒí•˜ë©´ ì•±ì²˜ëŸ¼ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </div>
</div>

<!-- TAB BAR -->
<nav class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('home',this)"><span class="icon">ğŸ </span><span>í™ˆ</span></button>
  <button class="tab-btn" onclick="switchTab('calendar',this)"><span class="icon">ğŸ“…</span><span>ìº˜ë¦°ë”</span></button>
  <button class="tab-btn" onclick="switchTab('coupon',this)"><span class="icon">ğŸ«</span><span>ì¿ í°</span></button>
  <button class="tab-btn" onclick="switchTab('stats',this)"><span class="icon">ğŸ˜Œ</span><span>í†µê³„</span></button>
  <button class="tab-btn" onclick="switchTab('settings',this)"><span class="icon">âš™ï¸</span><span>ì„¤ì •</span></button>
</nav>
</div>

<div class="toast" id="toast"></div>

<!-- ===== ADD/EDIT RECORD PANEL ===== -->
<div class="overlay" id="overlay-record">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="flex-between" style="margin-bottom:20px;">
      <div class="panel-title" id="record-panel-title">ê´€ëŒ ê¸°ë¡ ì¶”ê°€</div>
      <button class="btn-icon" onclick="closePanel('overlay-record')">âœ•</button>
    </div>
    <input type="hidden" id="edit-record-id">

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ë‚ ì§œ *</label>
        <input type="date" class="form-control" id="rec-date" onchange="autoFillCasting()">
      </div>
      <div class="form-group">
        <label class="form-label">ì‹œê°„ *</label>
        <select class="form-control" id="rec-time" onchange="onTimeChange()">
          <option value="">ì„ íƒ</option>
          <option value="14:00">14:00</option>
          <option value="16:00">16:00</option>
          <option value="18:00">18:00</option>
          <option value="20:00">20:00</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ìŠ¤ì¹´ì¼ëŸ¬ *</label>
        <select class="form-control" id="rec-skylar">
          <option value="">ì„ íƒ</option>
          <option value="ì£¼ë¯¼ì§„">ì£¼ë¯¼ì§„</option>
          <option value="ê³ ìƒí˜¸">ê³ ìƒí˜¸</option>
          <option value="ê¸°ì„¸ì¤‘">ê¸°ì„¸ì¤‘</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ë””ë”” *</label>
        <select class="form-control" id="rec-didi">
          <option value="">ì„ íƒ</option>
          <option value="ì •íœ˜">ì •íœ˜</option>
          <option value="ì´í•œì†”">ì´í•œì†”</option>
          <option value="ë°•ì£¼í˜">ë°•ì£¼í˜</option>
        </select>
      </div>
    </div>

    <!-- ë¯¸ì • ì²´í¬ (ê¸°ë³¸ ì˜ˆë§¤í™•ì •) -->
    <div class="form-group" style="display:flex;align-items:center;gap:10px;padding:4px 0;">
      <label style="display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer;color:var(--text2);">
        <input type="checkbox" id="rec-unconfirmed" onchange="onUnconfirmedChange()" style="width:16px;height:16px;accent-color:var(--accent);">
        ë¯¸ì • (ì˜ˆë§¤ ë¯¸í™•ì •)
      </label>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ì¢Œì„ êµ¬ì—­</label>
        <select class="form-control" id="rec-zone">
          <option value="">-</option>
          <option value="A">Aêµ¬ì—­</option>
          <option value="B">Bêµ¬ì—­</option>
          <option value="C">Cêµ¬ì—­</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ì—´</label>
        <input type="number" class="form-control" id="rec-row" placeholder="0-13" min="0" max="13">
      </div>
      <div class="form-group">
        <label class="form-label">ë²ˆí˜¸</label>
        <input type="number" class="form-control" id="rec-num" placeholder="ë²ˆí˜¸" min="1">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">í• ì¸ê¶Œì¢… <span style="color:var(--text3);font-weight:400;">(ì„ íƒ)</span></label>
      <select class="form-control" id="rec-discount-type" onchange="onDiscountTypeChange()">
        <option value="">ì—†ìŒ (ì¼ë°˜)</option>
        <option value="í”„ë¦¬ë·°">í”„ë¦¬ë·°</option>
        <option value="ì¬ê´€ëŒ">ì¬ê´€ëŒ</option>
        <option value="40% í• ì¸ê¶Œ">40% í• ì¸ê¶Œ</option>
        <option value="50% í• ì¸ê¶Œ">50% í• ì¸ê¶Œ</option>
        <option value="ì¦ë¹™ í”„ë¦¬íŒ¨ìŠ¤">ì¦ë¹™ í”„ë¦¬íŒ¨ìŠ¤</option>
        <option value="ì°½ì‘ì‚°ì‹¤ í• ì¸">ì°½ì‘ì‚°ì‹¤ í• ì¸</option>
        <option value="íƒ€ì„ì„¸ì¼">íƒ€ì„ì„¸ì¼</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>
      <div id="rec-discount-warn" style="display:none;margin-top:6px;font-size:12px;color:var(--danger);">âš  í•´ë‹¹ ì¿ í° ì”ì—¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
    </div>

    <div class="form-group">
      <label class="form-label">í‹°ì¼“ ê°€ê²© (ì›)</label>
      <input type="number" class="form-control" id="rec-price" placeholder="ì˜ˆ: 45000">
    </div>

    <div class="form-group">
      <label class="form-label">í•œì¤„ ì½”ë©˜íŠ¸</label>
      <input type="text" class="form-control" id="rec-comment" placeholder="ì˜ˆë§¤ì²˜, ë„ì¥êµí™˜ ìƒëŒ€ ë“±">
    </div>

    <!-- êµì‹ ì¼ì§€ ì¹´ë“œ -->
    <div class="form-group" id="rec-stamp-group">
      <label class="form-label">êµì‹ ì¼ì§€ ì¹´ë“œ</label>
      <select class="form-control" id="rec-stamp-board" onchange="onRecStampBoardChange()">
        <option value="">ì—°ë™ ì•ˆ í•¨</option>
      </select>
      <div style="margin-top:6px;">
        <button type="button" class="btn btn-outline btn-sm" style="width:100%;" onclick="openAddStampBoardFromRecord()">+ ìƒˆ ë„ì¥íŒ ë§Œë“¤ê¸°</button>
      </div>
      <div id="rec-stamp-qty-group" style="display:none;margin-top:10px;">
        <label class="form-label">ë„ì¥ ìˆ˜ëŸ‰</label>
        <div style="display:flex;gap:8px;">
          <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:5px;padding:7px;border:1.5px solid var(--accent);border-radius:8px;cursor:pointer;font-size:13px;color:var(--accent);font-weight:700;" id="rec-qty-label-1">
            <input type="radio" name="rec-stamp-qty" value="1" checked onchange="updateRecQtyLabel()"> 1ê°œ
          </label>
          <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:5px;padding:7px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;" id="rec-qty-label-2">
            <input type="radio" name="rec-stamp-qty" value="2" onchange="updateRecQtyLabel()"> 2ê°œ
          </label>
          <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:5px;padding:7px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;" id="rec-qty-label-3">
            <input type="radio" name="rec-stamp-qty" value="3" onchange="updateRecQtyLabel()"> 3ê°œ
          </label>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">ë³„ì </label>
      <div class="star-group" id="star-group">
        <button class="star-btn" onclick="setStar(1)">â˜†</button>
        <button class="star-btn" onclick="setStar(2)">â˜†</button>
        <button class="star-btn" onclick="setStar(3)">â˜†</button>
        <button class="star-btn" onclick="setStar(4)">â˜†</button>
        <button class="star-btn" onclick="setStar(5)">â˜†</button>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">ê°ìƒ ë©”ëª¨</label>
      <textarea class="form-control" id="rec-memo" placeholder="ììœ ë¡­ê²Œ ê¸°ë¡í•´ë³´ì„¸ìš”..."></textarea>
    </div>

    <div style="display:flex;gap:10px;margin-top:8px;">
      <button class="btn btn-primary" style="flex:1;" onclick="saveRecord()">ì €ì¥</button>
      <button class="btn btn-outline" onclick="closePanel('overlay-record')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ===== RECORD DETAIL PANEL ===== -->
<div class="overlay" id="overlay-detail">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="flex-between" style="margin-bottom:16px;">
      <div class="panel-title" id="detail-title"></div>
      <button class="btn-icon" onclick="closePanel('overlay-detail')">âœ•</button>
    </div>
    <div id="detail-content"></div>
    <div style="display:flex;gap:10px;margin-top:16px;">
      <button class="btn btn-outline" style="flex:1;" onclick="editCurrentRecord()">ìˆ˜ì •</button>
      <button class="btn btn-danger btn-sm" onclick="deleteCurrentRecord()">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- ===== DIRECT STAMP HISTORY PANEL ===== -->
<div class="overlay" id="overlay-direct-stamp">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="flex-between" style="margin-bottom:20px;">
      <div class="panel-title">ì´ë ¥ ì§ì ‘ ì¶”ê°€</div>
      <button class="btn-icon" onclick="closePanel('overlay-direct-stamp')">âœ•</button>
    </div>
    <div class="form-group">
      <label class="form-label">ë‚ ì§œ</label>
      <input type="date" class="form-control" id="direct-stamp-date">
    </div>
    <div class="form-group">
      <label class="form-label">ì½”ë©˜íŠ¸ (ì„ íƒ)</label>
      <input type="text" class="form-control" id="direct-stamp-comment" placeholder="ì˜ˆ: í¬ë‹¬ ì–‘ë„">
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px;" onclick="saveDirectStampHistory()">ì¶”ê°€</button>
  </div>
</div>

<!-- ===== STAMP HISTORY PANEL ===== -->
<div class="overlay" id="overlay-stamp-history">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="flex-between" style="margin-bottom:16px;">
      <div class="panel-title" id="stamp-history-panel-title">ì´ë ¥</div>
      <button class="btn-icon" onclick="closePanel('overlay-stamp-history')">âœ•</button>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:8px;">
      <button class="btn btn-outline btn-sm" onclick="openAddStampHistoryDirectFromPanel()">+ ì´ë ¥ ì¶”ê°€</button>
    </div>
    <div id="stamp-history-panel-content"></div>
  </div>
</div>

<!-- ===== ADD STAMP BOARD PANEL ===== -->
<div class="overlay" id="overlay-stamp">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="flex-between" style="margin-bottom:20px;">
      <div class="panel-title">ìƒˆ ë„ì¥íŒ ì‹œì‘</div>
      <button class="btn-icon" onclick="closePanel('overlay-stamp')">âœ•</button>
    </div>
    <div style="background:var(--accent-light);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:12px;color:var(--accent);">
      <div style="font-weight:700;margin-bottom:6px;">ğŸ“‹ êµì‹ ì¼ì§€ ì¹´ë“œ í˜œíƒ</div>
      <div style="display:flex;gap:12px;margin-bottom:8px;">
        <div style="flex:1;text-align:center;background:var(--bg1);border-radius:8px;padding:6px 4px;">
          <div style="font-size:11px;color:var(--text3);margin-bottom:2px;">3ì¹¸ ë‹¬ì„±</div>
          <div style="font-weight:700;color:var(--text1);">50% í• ì¸ê¶Œ</div>
        </div>
        <div style="flex:1;text-align:center;background:var(--bg1);border-radius:8px;padding:6px 4px;">
          <div style="font-size:11px;color:var(--text3);margin-bottom:2px;">7ì¹¸ ë‹¬ì„±</div>
          <div style="font-weight:700;color:var(--text1);">ì‹¤í™© OST</div>
        </div>
      </div>
      <div style="font-size:11px;color:var(--text2);line-height:1.7;">
        <div>ğŸ“ NOL ì„œê²½ìŠ¤í€˜ì–´ 3ì¸µ ìŠ¤ì½˜ 2ê´€ ë¡œë¹„ MDë¶€ìŠ¤</div>
        <div>ğŸ—“ ìš´ì˜ 2026.3.5 ~ 5.31 Â· í• ì¸ê¶Œ ì‚¬ìš© 2026.3.7 ~ 5.31</div>
        <div>â° ê³µì—° ì‹œì‘ 1ì‹œê°„ ì „ ~ ì¢…ë£Œ í›„ 10ë¶„</div>
        <div style="margin-top:4px;color:var(--text3);">Â· í•œ íšŒì°¨ ìœ ë£Œí‹°ì¼“ 1ë§¤ë§Œ ì ë¦½ ê°€ëŠ¥ (ë™ì¼ íšŒì°¨ ì¤‘ë³µ ë¶ˆê°€)</div>
        <div style="color:var(--text3);">Â· í‹°ì¼“ ì—¬ëŸ¬ ì¥ êµ¬ë§¤ ì‹œ ë‹¤ë¥¸ ë„ì¥íŒì— ë¶„ì‚° ì ë¦½ ê°€ëŠ¥</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ë„ì¥íŒ ì´ë¦„ <span style="color:var(--text3);font-weight:400;">(ë¹„ì›Œë‘ë©´ ìˆ«ì ìë™)</span></label>
      <input type="text" class="form-control" id="stamp-name" placeholder="ì˜ˆ: A, ì²«ë²ˆì§¸...">
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px;" onclick="saveStampBoard()">ì‹œì‘í•˜ê¸°</button>
  </div>
</div>

<!-- ===== ADD STAMP PANEL ===== -->
<div class="overlay" id="overlay-add-stamp">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="flex-between" style="margin-bottom:20px;">
      <div class="panel-title">ë„ì¥ ì°ê¸°</div>
      <button class="btn-icon" onclick="closePanel('overlay-add-stamp')">âœ•</button>
    </div>
    <input type="hidden" id="stamp-board-id">
    <div class="form-group">
      <label class="form-label">ë„ì¥ ì¶”ê°€ ë°©ì‹</label>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <label style="display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer;"><input type="radio" name="stamp-method" value="ì§ì ‘ ê´€ëŒ" checked> ì§ì ‘ ê´€ëŒ</label>
        <label style="display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer;"><input type="radio" name="stamp-method" value="ì ë¦½ê¶Œ ì‚¬ìš©"> ì ë¦½ê¶Œ ì‚¬ìš©</label>
        <label style="display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer;"><input type="radio" name="stamp-method" value="ë‚˜ëˆ” ìˆ˜ë ¹"> ë‚˜ëˆ” ìˆ˜ë ¹</label>
      </div>
    </div>
    <div class="form-group" style="margin-top:12px;">
      <label class="form-label">ìˆ˜ëŸ‰</label>
      <div style="display:flex;gap:8px;">
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border:1.5px solid var(--accent);border-radius:8px;cursor:pointer;font-size:14px;color:var(--accent);font-weight:700;" id="qty-label-1">
          <input type="radio" name="stamp-qty" value="1" checked onchange="updateQtyLabel()"> 1ê°œ
        </label>
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:14px;" id="qty-label-2">
          <input type="radio" name="stamp-qty" value="2" onchange="updateQtyLabel()"> 2ê°œ
        </label>
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:14px;" id="qty-label-3">
          <input type="radio" name="stamp-qty" value="3" onchange="updateQtyLabel()"> 3ê°œ
        </label>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ë‚ ì§œ</label>
      <input type="date" class="form-control" id="stamp-date">
    </div>
    <div class="form-group">
      <label class="form-label">ì½”ë©˜íŠ¸ (ì„ íƒ)</label>
      <input type="text" class="form-control" id="stamp-comment" placeholder="ë©”ëª¨">
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px;" onclick="addStamp()">ë„ì¥ ì°ê¸°</button>
  </div>
</div>

<!-- ===== ADD COUPON MANUAL PANEL ===== -->
<div class="overlay" id="overlay-coupon-manual">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="flex-between" style="margin-bottom:20px;">
      <div class="panel-title">í• ì¸ê¶Œ ì¶”ê°€/ì°¨ê°</div>
      <button class="btn-icon" onclick="closePanel('overlay-coupon-manual')">âœ•</button>
    </div>
    <div class="form-group">
      <label class="form-label">ì¢…ë¥˜</label>
      <select class="form-control" id="manual-coupon-key">
        <option value="discount40">40% í• ì¸ê¶Œ</option>
        <option value="discount50">50% í• ì¸ê¶Œ</option>
        <option value="discountPass">í• ì¸ ì¦ë¹™ PASS</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">ìœ í˜•</label>
      <div style="display:flex;gap:8px;">
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px;border:1.5px solid var(--accent);border-radius:8px;cursor:pointer;font-size:13px;color:var(--accent);font-weight:700;" id="manual-type-label-íšë“">
          <input type="radio" name="manual-coupon-type" value="íšë“" checked onchange="updateManualTypeLabel()"> íšë“
        </label>
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;" id="manual-type-label-ì‚¬ìš©">
          <input type="radio" name="manual-coupon-type" value="ì‚¬ìš©" onchange="updateManualTypeLabel()"> ì‚¬ìš©
        </label>
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;" id="manual-type-label-ë³µì›">
          <input type="radio" name="manual-coupon-type" value="ë³µì›" onchange="updateManualTypeLabel()"> ë³µì›
        </label>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ìˆ˜ëŸ‰</label>
      <div style="display:flex;gap:8px;">
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px;border:1.5px solid var(--accent);border-radius:8px;cursor:pointer;font-size:13px;color:var(--accent);font-weight:700;" id="manual-qty-label-1">
          <input type="radio" name="manual-coupon-qty" value="1" checked onchange="updateManualQtyLabel()"> 1ê°œ
        </label>
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;" id="manual-qty-label-2">
          <input type="radio" name="manual-coupon-qty" value="2" onchange="updateManualQtyLabel()"> 2ê°œ
        </label>
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;" id="manual-qty-label-3">
          <input type="radio" name="manual-coupon-qty" value="3" onchange="updateManualQtyLabel()"> 3ê°œ
        </label>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ë‚ ì§œ</label>
      <input type="date" class="form-control" id="manual-coupon-date">
    </div>
    <div class="form-group">
      <label class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
      <input type="text" class="form-control" id="manual-coupon-comment" placeholder="ì˜ˆ: í”„ë¡œì¹´ìš´í„° êµí™˜">
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px;" onclick="saveManualCoupon()">ì €ì¥</button>
  </div>
</div>

<!-- ===== COUPON PACK PANEL ===== -->
<div class="overlay" id="overlay-coupon-pack">
  <div class="panel">
    <div class="panel-handle"></div>
    <div class="flex-between" style="margin-bottom:20px;">
      <div class="panel-title">ì¿ í°íŒ© ì¶”ê°€</div>
      <button class="btn-icon" onclick="closePanel('overlay-coupon-pack')">âœ•</button>
    </div>
    <div style="background:var(--accent-light);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:13px;color:var(--accent);">
      <div style="font-weight:700;margin-bottom:4px;">ğŸ ì¿ í°íŒ© êµ¬ì„±</div>
      <div>40% í• ì¸ê¶Œ Ã— 1</div>
      <div>50% í• ì¸ê¶Œ Ã— 1</div>
      <div>í• ì¸ ì¦ë¹™ PASS Ã— 1</div>
    </div>
    <div class="form-group">
      <label class="form-label">íšë“ ë‚ ì§œ</label>
      <input type="date" class="form-control" id="coupon-pack-date">
    </div>
    <div class="form-group">
      <label class="form-label">ì½”ë©˜íŠ¸ (ì„ íƒ)</label>
      <input type="text" class="form-control" id="coupon-pack-comment" placeholder="ì˜ˆ: í”„ë¡œì¹´ìš´í„° êµí™˜">
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px;" onclick="saveCouponPack()">ì¶”ê°€</button>
  </div>
</div>

<script>
// ============================================================
// DATA LAYER
// ============================================================
const DB = {
  get(key, def) { try { return JSON.parse(localStorage.getItem('roger_'+key)) ?? def; } catch { return def; } },
  set(key, val) { localStorage.setItem('roger_'+key, JSON.stringify(val)); }
};
function getRecords()      { return DB.get('records', []); }
function saveRecords(r)    { DB.set('records', r); }
function getSchedule()     { return DB.get('schedule', []); }
function saveSchedule(s)   { DB.set('schedule', s); }
function getEvents() {
  return DB.get('events', [
    { name:'ìŠ¤í˜ì…œì»¤íŠ¼ì½œ', startDate:'2026-03-31', endDate:'2026-04-05', color:'#8B5CF6' },
    { name:'íŠ¸ë¦¬í”Œì ë¦½',   startDate:'2026-04-07', endDate:'2026-04-12', color:'#F59E0B' }
  ]);
}
function saveEvents(ev)    { DB.set('events', ev); }
function migrateStampBoards(boards) {
  return boards.map(b => {
    if (!b.milestones) {
      // notified=true if already past the milestone (avoid re-alerting on old data)
      b.milestones = [{ at: 3, reward: '50% í• ì¸ê¶Œ', couponKey: 'discount50', notified: b.currentCount >= 3 }];
    }
    if (!b.totalSlots) b.totalSlots = 7;
    if (!b.reward)     b.reward     = 'ì‹¤í™© OST';
    if (!b.history)    b.history    = [];
    return b;
  });
}
function getStampBoards()  { return migrateStampBoards(DB.get('stamp_boards', [])); }
function saveStampBoards(s){ DB.set('stamp_boards', s); }
function getCoupons() {
  return DB.get('coupons', {
    discount40:   { count: 0, history: [] },
    discount50:   { count: 0, history: [] },
    discountPass: { count: 0, history: [] }
  });
}
function saveCoupons(c) { DB.set('coupons', c); }
function getSettings()     { return DB.get('settings', { darkMode: false }); }
function saveSettings(s)   { DB.set('settings', s); }
function uuid()            { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

// ============================================================
// TAB NAVIGATION
// ============================================================
function switchTab(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  btn.classList.add('active');
  if (name==='home')     renderHome();
  if (name==='calendar') renderCalendar();
  if (name==='stats')    renderStats();
  if (name==='coupon')   renderCoupon();
  if (name==='settings') {
    const savedAt = localStorage.getItem('scheduleUpdatedAt');
    const timeEl  = document.getElementById('schedule-update-time');
    if (timeEl) timeEl.textContent = savedAt ? savedAt + ' (ìºì‹œ)' : 'ì—†ìŒ';
    const evSavedAt = localStorage.getItem('eventsUpdatedAt');
    const evTimeEl  = document.getElementById('event-update-time');
    if (evTimeEl) evTimeEl.textContent = evSavedAt ? evSavedAt + ' (ìºì‹œ)' : 'ì—†ìŒ';
  }
}

// ============================================================
// PANEL / OVERLAY
// ============================================================
function openPanel(id)  { document.getElementById(id).classList.add('open'); }
function closePanel(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(ov => {
  ov.addEventListener('click', e => { if (e.target===ov) ov.classList.remove('open'); });
});

// ============================================================
// TOAST
// ============================================================
let _toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ============================================================
// STAR RATING
// ============================================================
let currentStar = 0;
function setStar(n) {
  currentStar = n;
  document.querySelectorAll('.star-btn').forEach((s,i) => s.textContent = i<n ? 'â˜…' : 'â˜†');
}
function resetStars() {
  currentStar = 0;
  document.querySelectorAll('.star-btn').forEach(s => s.textContent = 'â˜†');
}

// ============================================================
// CASTING AUTO-FILL
// ============================================================
function autoFillCasting() {
  const date = document.getElementById('rec-date').value;
  const timeSelect = document.getElementById('rec-time');
  if (!date) return;
  const matches = getSchedule().filter(s => s.date===date);
  if (matches.length > 0) {
    const cur = timeSelect.value;
    timeSelect.innerHTML = '<option value="">ì„ íƒ</option>';
    matches.sort((a,b)=>a.time.localeCompare(b.time)).forEach(s => {
      const o = document.createElement('option');
      o.value = s.time; o.textContent = s.time;
      timeSelect.appendChild(o);
    });
    if (matches.length===1) {
      timeSelect.value = matches[0].time;
      document.getElementById('rec-skylar').value = matches[0].skylar||'';
      document.getElementById('rec-didi').value   = matches[0].didi||'';
    } else if (cur) {
      timeSelect.value = cur;
      const m = matches.find(s=>s.time===cur);
      if (m) { document.getElementById('rec-skylar').value=m.skylar||''; document.getElementById('rec-didi').value=m.didi||''; }
    }
  } else { resetTimeOptions(); }
}
function onTimeChange() {
  const date = document.getElementById('rec-date').value;
  const time = document.getElementById('rec-time').value;
  if (!date||!time) return;
  const m = getSchedule().find(s=>s.date===date&&s.time===time);
  if (m) { document.getElementById('rec-skylar').value=m.skylar||''; document.getElementById('rec-didi').value=m.didi||''; }
}
function resetTimeOptions() {
  document.getElementById('rec-time').innerHTML = `<option value="">ì„ íƒ</option><option value="14:00">14:00</option><option value="16:00">16:00</option><option value="18:00">18:00</option><option value="20:00">20:00</option>`;
}
function onUnconfirmedChange() {
  // purely visual feedback if needed â€“ isBooked is read from checkbox at save time
}

// ============================================================
// STAMP BOARD SELECT in RECORD FORM
// ============================================================
function populateStampSelect() {
  const sel    = document.getElementById('rec-stamp-board');
  const boards = getStampBoards();
  sel.innerHTML = '<option value="">ì—°ë™ ì•ˆ í•¨</option>';
  boards.forEach(b => {
    const o = document.createElement('option');
    o.value = b.id;
    const done = b.currentCount >= b.totalSlots;
    o.textContent = `${b.name} (${b.currentCount}/${b.totalSlots})${done ? ' âœ“ì™„ì„±' : ''}`;
    if (done) o.style.color = 'var(--text3)';
    sel.appendChild(o);
  });
}

// ============================================================
// ADD / EDIT RECORD
// ============================================================
function openAddRecord(date) {
  document.getElementById('record-panel-title').textContent = 'ê´€ëŒ ê¸°ë¡ ì¶”ê°€';
  document.getElementById('edit-record-id').value = '';
  document.getElementById('rec-date').value = date||'';
  resetTimeOptions();
  document.getElementById('rec-time').value = '';
  document.getElementById('rec-skylar').value = '';
  document.getElementById('rec-didi').value = '';
  document.getElementById('rec-zone').value = '';
  document.getElementById('rec-row').value = '';
  document.getElementById('rec-num').value = '';
  document.getElementById('rec-price').value = '';
  document.getElementById('rec-discount-type').value = '';
  document.getElementById('rec-discount-warn').style.display = 'none';
  document.getElementById('rec-comment').value = '';
  document.getElementById('rec-memo').value = '';
  document.getElementById('rec-unconfirmed').checked = false; // default: confirmed (isBooked=true)
  populateStampSelect();
  document.getElementById('rec-stamp-board').value = '';
  resetStars();
  if (date) autoFillCasting();
  openPanel('overlay-record');
}

function editRecord(id) {
  const r = getRecords().find(x=>x.id===id);
  if (!r) return;
  closePanel('overlay-detail');
  document.getElementById('record-panel-title').textContent = 'ê´€ëŒ ê¸°ë¡ ìˆ˜ì •';
  document.getElementById('edit-record-id').value = id;
  document.getElementById('rec-date').value = r.date;
  resetTimeOptions();
  autoFillCasting();
  document.getElementById('rec-time').value = r.time;
  document.getElementById('rec-skylar').value = r.skylar;
  document.getElementById('rec-didi').value = r.didi;
  document.getElementById('rec-zone').value = r.seatZone||'';
  document.getElementById('rec-row').value = r.seatRow!==null&&r.seatRow!==undefined ? r.seatRow : '';
  document.getElementById('rec-num').value = r.seatNumber||'';
  document.getElementById('rec-price').value = r.price||'';
  document.getElementById('rec-discount-type').value = r.discountType||'';
  document.getElementById('rec-discount-warn').style.display = 'none';
  document.getElementById('rec-comment').value = r.comment||'';
  document.getElementById('rec-memo').value = r.memo||'';
  // isBooked: true by default; unconfirmed = !isBooked
  document.getElementById('rec-unconfirmed').checked = !(r.isBooked !== false);
  populateStampSelect();
  // ìˆ˜ì • ì‹œ ê¸°ì¡´ ë„ì¥íŒ ì„ íƒê°’ ë³µì› (ìˆ˜ëŸ‰ì€ 1ë¡œ ì´ˆê¸°í™” â€” ì¶”ê°€ ì°ê¸°ìš©)
  document.getElementById('rec-stamp-board').value = r.stampBoardId || '';
  onRecStampBoardChange();
  setStar(r.rating||0);
  openPanel('overlay-record');
}

function saveRecord() {
  const date   = document.getElementById('rec-date').value;
  const time   = document.getElementById('rec-time').value;
  const skylar = document.getElementById('rec-skylar').value;
  const didi   = document.getElementById('rec-didi').value;
  if (!date||!time||!skylar||!didi) { showToast('ë‚ ì§œ, ì‹œê°„, ìºìŠ¤íŒ…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤'); return; }

  const records  = getRecords();
  const editId   = document.getElementById('edit-record-id').value;
  const rowVal   = document.getElementById('rec-row').value;
  const numVal   = document.getElementById('rec-num').value;
  const priceVal = document.getElementById('rec-price').value;
  const isBooked = !document.getElementById('rec-unconfirmed').checked;
  const stampBoardId  = document.getElementById('rec-stamp-board').value;
  const recQtyEl      = document.querySelector('input[name="rec-stamp-qty"]:checked');
  const stampQty      = recQtyEl ? parseInt(recQtyEl.value) || 1 : 1;
  const discountType  = document.getElementById('rec-discount-type').value || null;
  const newCouponKey  = DISCOUNT_COUPON_MAP[discountType] || null;

  // ì¿ í° ì”ì—¬ ì²´í¬ (ì‹ ê·œ ë˜ëŠ” í• ì¸ê¶Œì¢… ë³€ê²½ ì‹œ)
  const prevRecord   = editId ? records.find(x => x.id === editId) : null;
  const prevDiscount = prevRecord?.discountType || null;
  const prevCouponKey = DISCOUNT_COUPON_MAP[prevDiscount] || null;
  const couponChanged = discountType !== prevDiscount;

  if (newCouponKey && couponChanged) {
    const boards = getStampBoards();
    const coupons = getCoupons();
    const available = calcCouponCount(newCouponKey, coupons, boards, records);
    // ì‹ ê·œ: ì•„ì§ ì´ record ì—†ìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì²´í¬. ìˆ˜ì •: ê¸°ì¡´ ì¿ í° ë°˜ë‚©ë¶„ ê³ ë ¤
    const effectiveAvailable = available + (prevCouponKey === newCouponKey ? 0 : prevCouponKey ? 0 : 0);
    if (available <= 0 && !(editId && prevCouponKey === newCouponKey)) {
      showToast('í•´ë‹¹ ì¿ í° ì”ì—¬ê°€ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
  }

  // ì¿ í° countëŠ” records ê¸°ë°˜ ì‹¤ì‹œê°„ ê³„ì‚° â€” historyì— ê¸°ë¡í•˜ì§€ ì•ŠìŒ
  const record = {
    id: editId||uuid(), date, time, skylar, didi, isBooked,
    seatZone:     document.getElementById('rec-zone').value||null,
    seatRow:      rowVal!=='' ? parseInt(rowVal) : null,
    seatNumber:   numVal!=='' ? parseInt(numVal) : null,
    price:        priceVal!=='' ? parseInt(priceVal) : null,
    discountType: discountType,
    stampBoardId: stampBoardId || null,
    rating:       currentStar,
    comment:      document.getElementById('rec-comment').value.trim(),
    memo:         document.getElementById('rec-memo').value.trim(),
    createdAt:    editId ? (prevRecord?.createdAt||new Date().toISOString()) : new Date().toISOString(),
    updatedAt:    new Date().toISOString()
  };

  if (editId) {
    records[records.findIndex(x=>x.id===editId)] = record;
    const prevStampBoardId = prevRecord?.stampBoardId || null;
    const stampChanged = stampBoardId !== prevStampBoardId;

    if (stampChanged) {
      const boards = getStampBoards();
      if (prevStampBoardId) {
        const prevBoard = boards.find(b => b.id === prevStampBoardId);
        if (prevBoard && prevBoard.history) {
          const idx = prevBoard.history.map((h,i)=>({h,i})).reverse()
            .find(({h}) => h.date === (prevRecord?.date || date));
          if (idx !== undefined) prevBoard.history.splice(idx.i, 1);
          recalcStampCount(prevBoard);
          revalidateMilestones(prevBoard);
        }
      }
      if (stampBoardId) {
        const newBoard = boards.find(b => b.id === stampBoardId);
        if (newBoard) {
          recalcStampCount(newBoard);
          if (newBoard.currentCount < newBoard.totalSlots) {
            const actualQty = Math.min(stampQty, newBoard.totalSlots - newBoard.currentCount);
            const qtyLabel  = actualQty > 1 ? ' Ã—' + actualQty : '';
            if (!newBoard.history) newBoard.history = [];
            newBoard.history.push({ date, method: `${skylar}Ã—${didi} ê´€ëŒ ì—°ë™` + qtyLabel, comment: '', qty: actualQty });
            recalcStampCount(newBoard);
            if (!newBoard.milestones) newBoard.milestones = [{ at:3, reward:'50% í• ì¸ê¶Œ', couponKey:'discount50', notified:false }];
            newBoard.milestones.forEach(m => {
              if (newBoard.currentCount >= m.at && !m.notified) m.notified = true;
            });
          }
        }
      }
      saveStampBoards(boards);
    }
    showToast('ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
  } else {
    records.push(record);
    if (stampBoardId) {
      const toastMsg = applyStampToBoard(stampBoardId, stampQty, date, `${skylar}Ã—${didi} ê´€ëŒ ì—°ë™`);
      showToast(toastMsg || 'ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
      showToast('ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
  }
  saveRecords(records);
  closePanel('overlay-record');
  refreshCurrentPage();
}

// ============================================================
// RECORD DETAIL
// ============================================================
let currentDetailId = null;
function openDetail(id) {
  currentDetailId = id;
  const r = getRecords().find(x=>x.id===id);
  if (!r) return;
  const dow = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const d = new Date(r.date+'T00:00:00');
  const bookedBadge = r.isBooked===false ? '<span style="font-size:11px;color:var(--text3);margin-left:6px;">ë¯¸ì •</span>' : '<span style="font-size:11px;color:var(--success);margin-left:6px;">âœ… ì˜ˆë§¤í™•ì •</span>';
  document.getElementById('detail-title').innerHTML = `${r.date} (${dow[d.getDay()]}) ${r.time}${bookedBadge}`;
  let html = `<div class="casting-display"><div class="casting-tag sky">ìŠ¤ì¹´ì¼ëŸ¬ ${r.skylar}</div><div class="casting-tag didi">ë””ë”” ${r.didi}</div></div>`;
  if (r.rating) html += `<div class="detail-field"><div class="detail-field-label">ë³„ì </div><div style="color:var(--star);font-size:20px;">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</div></div>`;
  if (r.comment) html += `<div class="detail-field"><div class="detail-field-label">í•œì¤„ ì½”ë©˜íŠ¸</div><div class="detail-field-value">${r.comment}</div></div>`;
  if (r.seatZone) {
    html += `<div class="detail-field"><div class="detail-field-label">ì¢Œì„</div><div class="detail-field-value">${r.seatZone}êµ¬ì—­ ${r.seatRow}ì—´ ${r.seatNumber}ë²ˆ</div></div>`;
    html += buildMiniSeat(r.seatZone, r.seatRow, r.seatNumber);
  }
  if (r.price != null && r.price !== '') html += `<div class="detail-field"><div class="detail-field-label">í‹°ì¼“ ê°€ê²©</div><div class="detail-field-value">â‚©${r.price.toLocaleString()}${r.discountType ? ` <span style="font-size:11px;color:var(--accent);background:var(--accent-light);padding:2px 6px;border-radius:4px;margin-left:4px;">${r.discountType}</span>` : ''}</div></div>`;
  if (r.stampBoardId) {
    const boards = getStampBoards();
    const board  = boards.find(b => b.id === r.stampBoardId);
    if (board) {
      recalcStampCount(board);
      // ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ ëˆ„ì í•©ìœ¼ë¡œ ì´ íšŒì°¨ì˜ ìˆœë²ˆ ê³„ì‚°
      const sorted = [...(board.history||[])].sort((a,z) => a.date.localeCompare(z.date));
      let cumulative = 0, seq = null;
      for (const h of sorted) {
        const hQty = (h.method && h.method.match(/Ã—(\d+)/)) ? parseInt(h.method.match(/Ã—(\d+)/)[1]) : 1;
        if (h.date === r.date && seq === null) seq = cumulative + 1;
        cumulative += hQty;
      }
      if (seq === null) seq = board.currentCount;
      html += `<div class="detail-field"><div class="detail-field-label">êµì‹ ì¼ì§€ ì¹´ë“œ</div><div class="detail-field-value">[ğŸ“¡ ${board.name}] ${seq}ë²ˆì§¸ ë„ì¥ (í˜„ì¬ ${board.currentCount}/${board.totalSlots}ì¹¸)</div></div>`;
    }
  }
  if (r.memo) html += `<div class="detail-field"><div class="detail-field-label">ê°ìƒ ë©”ëª¨</div><div class="detail-field-value" style="font-size:14px;line-height:1.6;white-space:pre-wrap;">${r.memo}</div></div>`;
  document.getElementById('detail-content').innerHTML = html;
  openPanel('overlay-detail');
}

function buildMiniSeat(zone, row, num) {
  const cfgs = {
    A: { s:2, e:13, cols: ()=>4 },
    B: { s:0, e:13, cols: (r)=>r===0?12:13 },
    C: { s:2, e:13, cols: ()=>4 }
  };
  // í†µí•© ë£¨í”„: A/Cì˜ 0~1í–‰ì„ ë¹ˆ ì¹¸ìœ¼ë¡œ ì±„ì›Œ Bì™€ í–‰ ë†’ì´ ì •ë ¬
  const zHtml = { A:'', B:'', C:'' };
  for (let r = 0; r <= 13; r++) {
    ['A','B','C'].forEach(z => {
      const c = cfgs[z];
      zHtml[z] += '<div class="mini-seat-row">';
      if (r < c.s || r > c.e) {
        const emptyCnt = z === 'B' ? (r===0?12:13) : 4;
        for (let i=0; i<emptyCnt; i++) zHtml[z] += '<div class="mini-seat-cell" style="visibility:hidden;"></div>';
      } else {
        for (let col=1; col<=c.cols(r); col++) {
          const hl = z===zone && r===parseInt(row) && col===parseInt(num);
          zHtml[z] += `<div class="mini-seat-cell${hl?' highlight':''}"></div>`;
        }
      }
      zHtml[z] += '</div>';
    });
  }
  let html = '<div class="mini-heatmap">';
  ['A','B','C'].forEach(z => {
    html += `<div class="mini-zone"><div class="mini-zone-label">${z}</div>${zHtml[z]}</div>`;
  });
  return html + '</div>';
}

function editCurrentRecord()   { if (currentDetailId) editRecord(currentDetailId); }
function deleteCurrentRecord() {
  if (!currentDetailId) return;
  if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const records = getRecords();
  const target  = records.find(x => x.id === currentDetailId);
  // ì¿ í° countëŠ” records ê¸°ë°˜ ì‹¤ì‹œê°„ ê³„ì‚° â€” ë³„ë„ ë³µì› ì²˜ë¦¬ ë¶ˆí•„ìš”
  // ë„ì¥íŒ ì´ë ¥ ë³µì›
  if (target?.stampBoardId) {
    const boards = getStampBoards();
    const board  = boards.find(b => b.id === target.stampBoardId);
    if (board && board.history) {
      const idx = board.history.map((h,i)=>({h,i})).reverse().find(({h}) => h.date === target.date);
      if (idx !== undefined) board.history.splice(idx.i, 1);
      recalcStampCount(board);
      revalidateMilestones(board);
      saveStampBoards(boards);
    }
  }
  saveRecords(records.filter(x => x.id !== currentDetailId));
  closePanel('overlay-detail');
  renderCouponList();
  showToast('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  refreshCurrentPage();
}

// ============================================================
// HOME
// ============================================================
function renderHome() {
  const records = getRecords();
  const today   = new Date().toISOString().slice(0,10);
  const dow     = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

  // ì˜ˆë§¤í™•ì • + ë¯¸ì • í¬í•¨ ë¯¸ë˜ ì¼ì •
  const upcoming = records
    .filter(r => r.date >= today)
    .sort((a,b) => a.date.localeCompare(b.date)||a.time.localeCompare(b.time));

  const nextShow = upcoming.find(r => r.isBooked !== false) || upcoming[0];
  const rest     = upcoming.filter(r => r !== nextShow);

  // â‘  D-day ì¹´ë“œ
  if (nextShow) {
    const d     = new Date(nextShow.date+'T00:00:00');
    const todayD = new Date(today+'T00:00:00');
    const diff  = Math.round((d-todayD)/86400000);
    const dday  = diff===0 ? 'D-DAY' : `D-${diff}`;
    const seat  = nextShow.seatZone ? `${nextShow.seatZone}êµ¬ì—­ ${nextShow.seatRow}ì—´ ${nextShow.seatNumber}ë²ˆ` : '';
    document.getElementById('home-next-show').innerHTML = `
      <div class="next-show-card" onclick="openDetail('${nextShow.id}')">
        <div class="next-show-dday${diff===0?' today-dday':''}">${dday}${nextShow.isBooked===false ? ' <span style="font-size:14px;opacity:0.7;font-weight:400;">ë¯¸ì •</span>' : ''}</div>
        <div class="next-show-date">${nextShow.date} (${dow[d.getDay()]}) ${nextShow.time}</div>
        <div class="next-show-casting">
          <span class="next-show-pill sky">ìŠ¤ì¹´ì¼ëŸ¬ ${nextShow.skylar}</span>
          <span class="next-show-pill didi">ë””ë”” ${nextShow.didi}</span>
        </div>
        ${seat ? `<div class="next-show-seat">ğŸ’º ${seat}</div>` : ''}
      </div>`;
  } else {
    document.getElementById('home-next-show').innerHTML = `
      <div class="card" style="text-align:center;color:var(--text3);padding:20px;">
        <div style="font-size:24px;margin-bottom:6px;">âœˆ</div>
        <div style="font-size:13px;">ì˜ˆë§¤ í™•ì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>
      </div>`;
  }

  // â‘¡ ë‚˜ë¨¸ì§€ ì˜ˆì • ì¼ì • ë¦¬ìŠ¤íŠ¸
  const upcomingCard = document.getElementById('home-upcoming-card');
  if (rest.length > 0) {
    upcomingCard.style.display = '';
    document.getElementById('home-upcoming').innerHTML = rest.map(r => {
      const d2   = new Date(r.date+'T00:00:00');
      const todayD2 = new Date(today+'T00:00:00');
      const diff2 = Math.round((d2-todayD2)/86400000);
      const dday2 = diff2===0 ? 'D-DAY' : `D-${diff2}`;
      return `<div class="upcoming-item" onclick="openDetail('${r.id}')">
        <div class="upcoming-dday" style="${r.isBooked===false ? 'color:var(--text3);' : ''}">${dday2}</div>
        <div class="upcoming-date">${r.date.slice(5)} (${dow[d2.getDay()]}) ${r.time}</div>
        <div class="upcoming-cast">${r.skylar}Ã—${r.didi}${r.isBooked===false ? ' <span style="font-size:10px;color:var(--text3);">ë¯¸ì •</span>' : ''}</div>
      </div>`;
    }).join('');
  } else {
    upcomingCard.style.display = 'none';
  }

  // â‘¢ ë„ì¥íŒ
  const boards = getStampBoards();
  document.getElementById('home-stamps').innerHTML = boards.length===0
    ? `<div style="color:var(--text3);font-size:13px;text-align:center;padding:8px;">ë„ì¥íŒì´ ì—†ìŠµë‹ˆë‹¤</div>`
    : boards.map(b => {
        const { cur, final } = calcStampCounts(b);
        const pct = Math.min(100, Math.round(cur/b.totalSlots*100));
        return `<div class="home-stamp-row">
          <div class="home-stamp-name">${cur>=b.totalSlots?'ğŸ‰ ':''}[ğŸ“¡ ${b.name}]</div>
          <div class="home-stamp-bar"><div class="home-stamp-bar-fill" style="width:${pct}%"></div></div>
          <div class="home-stamp-count">${cur}/${b.totalSlots}</div>
        </div>`;
      }).join('');

  // â‘£ ì¿ í°
  const coupons = getCoupons();
  const todayStr = new Date().toISOString().slice(0, 10);
  const c40  = calcCouponCount('discount40',   coupons, boards, records, todayStr);
  const c50  = calcCouponCount('discount50',   coupons, boards, records, todayStr);
  const cPas = calcCouponCount('discountPass', coupons, boards, records, todayStr);
  document.getElementById('home-coupons').innerHTML = `
    <div class="home-coupon-row"><span class="home-coupon-name">ğŸ· 40% í• ì¸ê¶Œ</span><span class="home-coupon-count">${c40}</span></div>
    <div class="home-coupon-row"><span class="home-coupon-name">ğŸ· 50% í• ì¸ê¶Œ</span><span class="home-coupon-count">${c50}</span></div>
    <div class="home-coupon-row"><span class="home-coupon-name">ğŸŸ í• ì¸ ì¦ë¹™ PASS</span><span class="home-coupon-count">${cPas}</span></div>`;

  // â‘¤ ìµœê·¼ ê´€ëŒ (ì´ë¯¸ ì§€ë‚œ ê²ƒ ë˜ëŠ” ë¯¸ì •)
  const past = records
    .filter(r => r.date < today)
    .sort((a,b)=>b.date.localeCompare(a.date)||b.time.localeCompare(a.time))
    .slice(0,3);
  document.getElementById('home-recent').innerHTML = past.length===0
    ? '<div style="text-align:center;color:var(--text3);padding:12px;font-size:13px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>'
    : past.map(r=>`
        <div class="record-mini" onclick="openDetail('${r.id}')">
          <div class="record-date-badge">${r.date.slice(5)}<br>${r.time}</div>
          <div class="record-casting">${r.skylar} Ã— ${r.didi}</div>
          <div class="record-rating">${r.rating?'â˜…'.repeat(r.rating):''}</div>
        </div>`).join('');
}

// ============================================================
// CALENDAR (ìŠ¤ì¼€ì¤„ í†µí•©)
// ============================================================
let calYear, calMonth;
let calFilterSky  = null;
let calFilterDidi = null;
let calSelectedDs = null;

function initCal() { const n=new Date(); calYear=n.getFullYear(); calMonth=n.getMonth(); }
function calPrev() { calMonth--; if(calMonth<0){calMonth=11;calYear--;} calSelectedDs=null; renderCalendar(); }
function calNext() { calMonth++; if(calMonth>11){calMonth=0;calYear++;} calSelectedDs=null; renderCalendar(); }

function setCalFilterSky(name, btn) {
  calFilterSky = name;
  document.querySelectorAll('#cal-chips-sky .cal-chip').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  updateCalFilterHint();
  renderCalendar();
}
function setCalFilterDidi(name, btn) {
  calFilterDidi = name;
  document.querySelectorAll('#cal-chips-didi .cal-chip').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  updateCalFilterHint();
  renderCalendar();
}
function updateCalFilterHint() {
  const el = document.getElementById('cal-filter-hint');
  if (!el) return;
  const hasFilter = calFilterSky || calFilterDidi;
  el.textContent = hasFilter
    ? `Â· ${[calFilterSky, calFilterDidi].filter(Boolean).join(' Ã— ')} íšŒì°¨ í‘œì‹œ ì¤‘`
    : 'Â· ì „ì²´ íšŒì°¨ í‘œì‹œ ì¤‘';
}

function getEventsForDate(ds, events) {
  return events.filter(ev => ev.startDate <= ds && ds <= ev.endDate);
}

function renderCalendar() {
  if (calYear===undefined) initCal();
  const records  = getRecords();
  const schedule = getSchedule();
  const events   = getEvents();

  const schByDate = {};
  schedule.forEach(s => {
    if (!schByDate[s.date]) schByDate[s.date] = [];
    schByDate[s.date].push(s);
  });

  const recordDates = new Set(records.map(r => r.date));
  const bookedDates = new Set(records.filter(r => r.isBooked!==false).map(r => r.date));
  const doneSet     = new Set(records.map(r => `${r.date}-${r.time}`));
  const bookedSet   = new Set(records.filter(r => r.isBooked!==false).map(r => `${r.date}-${r.time}`));

  const dow    = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const months = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
  document.getElementById('cal-title').textContent = `${calYear}ë…„ ${months[calMonth]}`;

  const firstDay   = new Date(calYear, calMonth, 1).getDay();
  const lastDate   = new Date(calYear, calMonth+1, 0).getDate();
  const todayStr   = new Date().toISOString().slice(0,10);
  const totalCells = firstDay + lastDate;
  const weeks      = Math.ceil(totalCells / 7);
  const monthStr   = `${calYear}-${String(calMonth+1).padStart(2,'0')}`;
  const monthStart = `${monthStr}-01`;
  const monthEnd   = `${monthStr}-${String(lastDate).padStart(2,'0')}`;

  // ì´ë²¤íŠ¸ segments â€” í–‰ë³„ ê²¹ì¹¨ ë°©ì§€ (max 3í–‰)
  const segments = [];
  events.forEach(ev => {
    if (ev.endDate < monthStart || ev.startDate > monthEnd) return;
    const clampedStart = ev.startDate < monthStart ? monthStart : ev.startDate;
    const clampedEnd   = ev.endDate   > monthEnd   ? monthEnd   : ev.endDate;
    const startCell = firstDay + parseInt(clampedStart.slice(8)) - 1;
    const endCell   = firstDay + parseInt(clampedEnd.slice(8))   - 1;
    for (let w = Math.floor(startCell/7); w <= Math.floor(endCell/7); w++) {
      const sc = Math.max(startCell, w*7) % 7;
      const ec = Math.min(endCell,   w*7+6) % 7;
      // ì´ weekì—ì„œ ê²¹ì¹˜ì§€ ì•ŠëŠ” ê°€ì¥ ë‚®ì€ row ì°¾ê¸° (max 3)
      const used = segments.filter(s => s.week === w);
      let row = 0;
      while (row < 3) {
        const conflict = used.filter(s => s.row === row).some(s =>
          !(ec < s.startCol || sc > s.endCol)
        );
        if (!conflict) break;
        row++;
      }
      if (row < 3) segments.push({ week: w, startCol: sc, endCol: ec, color: ev.color, name: ev.name, row });
    }
  });

  let html = `<div class="cal-grid">${dow.map(d=>`<div class="cal-dow">${d}</div>`).join('')}</div>`;

  for (let w = 0; w < weeks; w++) {
    const wSegs = segments.filter(s => s.week === w);
    const maxRow = wSegs.length ? Math.max(...wSegs.map(s => s.row)) + 1 : 0;

    // ë‚ ì§œ í–‰
    html += '<div class="cal-grid">';
    for (let col = 0; col < 7; col++) {
      const cell = w*7+col;
      const day  = cell-firstDay+1;
      if (cell < firstDay || day > lastDate) { html += '<div class="cal-day empty"></div>'; continue; }

      const ds     = `${monthStr}-${String(day).padStart(2,'0')}`;
      const dow2   = new Date(calYear, calMonth, day).getDay();
      const daySch = schByDate[ds] || [];
      const filteredDaySch = daySch.filter(s =>
        (!calFilterSky  || s.skylar === calFilterSky) &&
        (!calFilterDidi || s.didi   === calFilterDidi)
      );

      let cls = 'cal-day';
      if (ds === todayStr)      cls += ' today';
      if (dow2 === 0)           cls += ' sun';
      else if (dow2 === 6)      cls += ' sat';
      if (ds === calSelectedDs) cls += ' selected';

      // ì´ ë‚ ì§œì— ê±¸ë¦¬ëŠ” ì´ë²¤íŠ¸ (rowë³„ë¡œ)
      const dayCell = w*7+col;
      let evHtml = '';
      for (let row = 0; row < maxRow; row++) {
        const seg = wSegs.find(s => s.row === row && s.startCol <= col && s.endCol >= col);
        if (seg) {
          // ë°”ì˜ ì‹œì‘ ì…€ì—ì„œë§Œ í…ìŠ¤íŠ¸ í‘œì‹œ, ë‚˜ë¨¸ì§€ëŠ” ìƒ‰ìƒ ì—°ì¥
          const isStart = seg.startCol === col;
          const isEnd   = seg.endCol   === col;
          const radius  = isStart && isEnd ? '4px' : isStart ? '4px 0 0 4px' : isEnd ? '0 4px 4px 0' : '0';
          const marginL = isStart ? '1px' : '0';
          const marginR = isEnd   ? '1px' : '0';
          evHtml += `<div style="height:15px;background:${seg.color};border-radius:${radius};margin:1px ${marginR} 0 ${marginL};display:flex;align-items:center;padding:0 ${isStart?'4px':'0'};overflow:hidden;">
            ${isStart ? `<span style="font-size:9px;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${seg.name}</span>` : ''}
          </div>`;
        } else {
          evHtml += `<div style="height:15px;margin:1px 0 0;"></div>`;
        }
      }

      // íšŒì°¨
      let sessionHtml = '';
      if (filteredDaySch.length) {
        sessionHtml = filteredDaySch
          .sort((a,b) => a.time.localeCompare(b.time))
          .map(s => {
            const key = `${ds}-${s.time}`;
            const isBooked = bookedSet.has(key);
            const isDone   = doneSet.has(key);
            const chipCls  = isBooked ? 'cal-session-chip booked' : isDone ? 'cal-session-chip done' : 'cal-session-chip';
            const icon     = isDone ? 'âœ…' : '';
            return `<div class="${chipCls}"><span class="cs-icon">${icon}</span><span class="cs-time">${s.time}</span></div>`;
          }).join('');
      }

      html += `<div class="${cls}" onclick="calDayClick('${ds}')">
        <span class="cal-day-num">${day}</span>
        ${evHtml}
        ${sessionHtml}
      </div>`;
    }
    html += '</div>';
  }

  document.getElementById('cal-wrap').innerHTML = html;

  if (calSelectedDs) {
    renderCalDayPanel(calSelectedDs, schByDate[calSelectedDs]||[], doneSet, bookedSet, records);
  } else {
    document.getElementById('cal-day-records').innerHTML = '';
  }
}

function calDayClick(ds) {
  if (calSelectedDs === ds) {
    calSelectedDs = null;
    document.getElementById('cal-day-records').innerHTML = '';
    renderCalendar();
    return;
  }
  calSelectedDs = ds;
  renderCalendar();
}

function renderCalDayPanel(ds, daySch, doneSet, bookedSet, records) {
  const dow  = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const d    = new Date(ds+'T00:00:00');
  const dateLabel = `${parseInt(ds.slice(5,7))}ì›” ${parseInt(ds.slice(8,10))}ì¼ (${dow[d.getDay()]})`;
  const dayRecords = records.filter(r => r.date === ds);

  let html = `<div class="cal-day-panel"><div class="cal-day-panel-title">${dateLabel}</div>`;

  const sorted = [...daySch].sort((a,b) => a.time.localeCompare(b.time));
  if (sorted.length) {
    sorted.forEach(s => {
      const key      = `${ds}-${s.time}`;
      const isDone   = doneSet.has(key);
      const isBooked = bookedSet.has(key);
      const rec      = dayRecords.find(r => r.time === s.time);
      const badge    = isDone   ? '<span class="cal-session-badge done">âœ…</span>'
                     : isBooked ? '<span class="cal-session-badge booked">âœ“ ì˜ˆë§¤í™•ì •</span>' : '';
      const btn      = isDone
        ? `<button class="cal-session-add" onclick="openDetail('${rec?.id}')">ìƒì„¸</button>`
        : `<button class="cal-session-add" onclick="openAddRecordFromSchedule('${ds}','${s.time}','${s.skylar}','${s.didi}')">+ ê¸°ë¡</button>`;
      html += `<div class="cal-session-row">
        <div class="cal-session-time">${s.time}</div>
        <div class="cal-session-casting"><span class="sky">${s.skylar}</span> Ã— <span class="didi">${s.didi}</span></div>
        ${badge}${btn}
      </div>`;
    });
  } else if (dayRecords.length) {
    dayRecords.sort((a,b)=>a.time.localeCompare(b.time)).forEach(r => {
      html += `<div class="cal-session-row">
        <div class="cal-session-time">${r.time}</div>
        <div class="cal-session-casting"><span class="sky">${r.skylar}</span> Ã— <span class="didi">${r.didi}</span></div>
        <span class="cal-session-badge done">âœ…</span>
        <button class="cal-session-add" onclick="openDetail('${r.id}')">ìƒì„¸</button>
      </div>`;
    });
  } else {
    html += '<div style="padding:12px 14px;color:var(--text3);font-size:13px;">ìŠ¤ì¼€ì¤„ ì—†ëŠ” ë‚ </div>';
  }

  html += `<div style="padding:10px 14px 14px;">
    <button class="btn btn-primary btn-sm" style="width:100%;" onclick="openAddRecord('${ds}')">+ ì´ ë‚  ê¸°ë¡ ì¶”ê°€</button>
  </div></div>`;
  document.getElementById('cal-day-records').innerHTML = html;
}

function openAddRecordFromSchedule(date, time, skylar, didi) {
  openAddRecord(date);
  setTimeout(() => {
    const timeEl = document.getElementById('rec-time');
    if (timeEl) timeEl.value = time;
    const skyEl = document.getElementById('rec-skylar');
    if (skyEl) { skyEl.value = skylar; skyEl.dispatchEvent(new Event('change')); }
    const didiEl = document.getElementById('rec-didi');
    if (didiEl) { didiEl.value = didi; didiEl.dispatchEvent(new Event('change')); }
  }, 80);
}


// ============================================================
// STATS (ì§€ì¶œë§Œ blur)
// ============================================================
let moneyBlurred = true;
function toggleMoneyBlur() {
  moneyBlurred = !moneyBlurred;
  const el  = document.getElementById('money-blur');
  const btn = document.getElementById('money-reveal-btn');
  if (moneyBlurred) { el.classList.add('blurred'); btn.textContent='ğŸ‘ğŸ‘'; }
  else              { el.classList.remove('blurred'); btn.textContent='ë‹¤ì‹œ ìˆ¨ê¸°ê¸° ğŸ˜Œ'; }
}

function renderStats() {
  const records  = getRecords();
  const schedule = getSchedule();
  const sky  = ['ì£¼ë¯¼ì§„','ê³ ìƒí˜¸','ê¸°ì„¸ì¤‘'];
  const didi = ['ì •íœ˜','ì´í•œì†”','ë°•ì£¼í˜'];
  const countAct = (f,n) => records.filter(r=>r[f]===n).length;
  const countSch = (f,n) => schedule.filter(s=>s[f]===n).length;

  let ah = `<tr><th colspan="3" class="role-section-title">ìŠ¤ì¹´ì¼ëŸ¬</th></tr><tr><th>ë°°ìš°</th><th>ì´ íšŒì°¨</th><th>ê´€ëŒ</th></tr>`;
  sky.forEach(a  => { ah += `<tr><td>${a}</td><td style="color:var(--text3)">${countSch('skylar',a)}</td><td>${countAct('skylar',a)}</td></tr>`; });
  ah += `<tr><th colspan="3" class="role-section-title">ë””ë””</th></tr><tr><th>ë°°ìš°</th><th>ì´ íšŒì°¨</th><th>ê´€ëŒ</th></tr>`;
  didi.forEach(a => { ah += `<tr><td>${a}</td><td style="color:var(--text3)">${countSch('didi',a)}</td><td>${countAct('didi',a)}</td></tr>`; });
  document.getElementById('stats-actors').innerHTML = ah;

  const pairs = [
    ['ì£¼ë¯¼ì§„','ì´í•œì†”'],['ê³ ìƒí˜¸','ì´í•œì†”'],['ê¸°ì„¸ì¤‘','ì´í•œì†”'],
    ['ì£¼ë¯¼ì§„','ì •íœ˜'],  ['ê³ ìƒí˜¸','ì •íœ˜'],  ['ê¸°ì„¸ì¤‘','ì •íœ˜'],
    ['ì£¼ë¯¼ì§„','ë°•ì£¼í˜'],['ê³ ìƒí˜¸','ë°•ì£¼í˜'],['ê¸°ì„¸ì¤‘','ë°•ì£¼í˜']
  ];
  let ph = '<tr><th>ìŠ¤ì¹´ì¼ëŸ¬</th><th>ë””ë””</th><th>ì´ íšŒì°¨</th><th>ê´€ëŒ</th></tr>';
  pairs.forEach(([s,d]) => {
    const tot = schedule.filter(x=>x.skylar===s&&x.didi===d).length;
    const seen = records.filter(r=>r.skylar===s&&r.didi===d).length;
    if (tot>0||seen>0) ph += `<tr><td>${s}</td><td>${d}</td><td style="color:var(--text3)">${tot}</td><td>${seen}</td></tr>`;
  });
  if (!ph.includes('<td>')) ph += '<tr><td colspan="4" style="text-align:center;color:var(--text3);padding:12px;">ê¸°ë¡ ì—†ìŒ</td></tr>';
  document.getElementById('stats-pairs').innerHTML = ph;

  renderHeatmap();

  const paid  = records.filter(r=>r.price != null && r.price !== '');
  const total = paid.reduce((s,r)=>s+(r.price||0),0);
  const avg   = paid.length ? Math.round(total/paid.length) : 0;
  document.getElementById('stats-money').innerHTML = `
    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text2)">ì´ ì§€ì¶œ</span><span style="font-weight:700;">â‚©${total.toLocaleString()}</span></div>
    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text2)">í‰ê·  í‹°ì¼“ê°€</span><span style="font-weight:700;">â‚©${avg.toLocaleString()}</span></div>
    <div style="display:flex;justify-content:space-between;padding:8px 0"><span style="color:var(--text2)">ìœ ë£Œ ê´€ëŒ íšŸìˆ˜</span><span style="font-weight:700;">${paid.length}íšŒ</span></div>`;

  // maintain blur state
  const blurEl = document.getElementById('money-blur');
  if (moneyBlurred) blurEl.classList.add('blurred'); else blurEl.classList.remove('blurred');
}

function renderHeatmap() {
  const records = getRecords();
  const seatMap = {};
  records.forEach(r => {
    if (r.seatZone && r.seatRow!==null && r.seatRow!==undefined && r.seatNumber) {
      const k = `${r.seatZone}-${r.seatRow}-${r.seatNumber}`;
      seatMap[k] = (seatMap[k]||0) + 1;
    }
  });
  const cls = c => !c?'': c>=5?'v5':'v'+c;

  // Aêµ¬ì—­: 0~13í–‰ 4ì—´ / Bêµ¬ì—­: 0~13í–‰(0í–‰=12ì—´, 1~13í–‰=13ì—´) / Cêµ¬ì—­: 0~13í–‰ 4ì—´
  const zones = [
    { name:'A', s:2, e:13, cols:()=>4 },
    { name:'B', s:0, e:13, cols:(r)=>r===0?12:13 },
    { name:'C', s:2, e:13, cols:()=>4 }
  ];
  const zHtml = { A:'', B:'', C:'' };
  for (let row = 0; row <= 13; row++) {
    zones.forEach(z => {
      if (row < z.s || row > z.e) {
        // ë¹ˆ placeholder í–‰ â€” ë†’ì´ ìœ ì§€ìš©
        zHtml[z.name] += `<div class="seat-row"><div class="row-label"></div>`;
        const emptyCnt = z.name === 'B' ? (row === 0 ? 12 : 13) : 4;
        for (let i = 0; i < emptyCnt; i++) {
          zHtml[z.name] += `<div class="seat-cell" style="visibility:hidden;"></div>`;
        }
        zHtml[z.name] += `</div>`;
      } else {
        const colCnt = z.cols(row);
        zHtml[z.name] += `<div class="seat-row"><div class="row-label">${row}ì—´</div>`;
        for (let col = 1; col <= colCnt; col++) {
          const k   = `${z.name}-${row}-${col}`;
          const cnt = seatMap[k] || 0;
          const c   = cls(cnt);
          zHtml[z.name] += `<div class="seat-cell${c?' '+c:''}" title="${z.name}${row}ì—´${col}ë²ˆ ${cnt}íšŒ"></div>`;
        }
        zHtml[z.name] += `</div>`;
      }
    });
  }
  let html = '';
  zones.forEach(z => {
    html += `<div class="zone-wrap"><div class="zone-label">${z.name}</div><div class="seat-grid">${zHtml[z.name]}</div></div>`;
  });
  document.getElementById('heatmap').innerHTML = html;
}

// ============================================================
// SCHEDULE â€” í•„í„° ìƒíƒœ ë³€ìˆ˜
// ============================================================


async function fetchSchedule(manual = false) {
  const statusEl = document.getElementById('schedule-fetch-status');
  const timeEl   = document.getElementById('schedule-update-time');
  if (statusEl) statusEl.textContent = 'ìŠ¤ì¼€ì¤„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  try {
    const res = await fetch('./schedule.json?t=' + Date.now());
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('í˜•ì‹ ì˜¤ë¥˜');
    saveSchedule(data);
    const now = new Date().toLocaleString('ko-KR', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });
    localStorage.setItem('scheduleUpdatedAt', now);
    if (timeEl) timeEl.textContent = now;
    if (statusEl) statusEl.textContent = `âœ“ ${data.length}ê°œ íšŒì°¨ ë¡œë“œë¨`;
    if (manual) showToast(`ìŠ¤ì¼€ì¤„ ${data.length}ê°œ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
    renderCalendar();
    renderHome();
  } catch (e) {
    // ì˜¤í”„ë¼ì¸ì´ë©´ ìºì‹œëœ ìŠ¤ì¼€ì¤„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    const cached = getSchedule();
    const savedAt = localStorage.getItem('scheduleUpdatedAt');
    if (timeEl) timeEl.textContent = savedAt ? `${savedAt} (ìºì‹œ)` : 'ìºì‹œ ì—†ìŒ';
    if (statusEl) statusEl.textContent = cached.length ? `ì˜¤í”„ë¼ì¸ â€” ${cached.length}ê°œ ìºì‹œ ì‚¬ìš© ì¤‘` : 'ìŠ¤ì¼€ì¤„ ì—†ìŒ';
    if (manual) showToast('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤');
  }
}

async function fetchEvents(manual = false) {
  const statusEl = document.getElementById('event-fetch-status');
  const timeEl   = document.getElementById('event-update-time');
  if (statusEl) statusEl.textContent = 'ì´ë²¤íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  try {
    const res = await fetch('./events.json?t=' + Date.now());
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('í˜•ì‹ ì˜¤ë¥˜');
    saveEvents(data);
    const now = new Date().toLocaleString('ko-KR', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });
    localStorage.setItem('eventsUpdatedAt', now);
    if (timeEl) timeEl.textContent = now;
    if (statusEl) statusEl.textContent = `âœ“ ${data.length}ê°œ ì´ë²¤íŠ¸ ë¡œë“œë¨`;
    if (manual) showToast(`ì´ë²¤íŠ¸ ${data.length}ê°œ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
    renderCalendar();
  } catch (e) {
    const cached = getEvents();
    const savedAt = localStorage.getItem('eventsUpdatedAt');
    if (timeEl) timeEl.textContent = savedAt ? `${savedAt} (ìºì‹œ)` : 'ìºì‹œ ì—†ìŒ';
    if (statusEl) statusEl.textContent = cached.length ? `ì˜¤í”„ë¼ì¸ â€” ${cached.length}ê°œ ìºì‹œ ì‚¬ìš© ì¤‘` : 'ì´ë²¤íŠ¸ ì—†ìŒ';
    if (manual) showToast('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤');
  }
}

// ============================================================
// ACTOR PHOTOS (ì„¤ì •)
// ============================================================
const ACTOR_ROLES = [
  { name:'ì£¼ë¯¼ì§„', role:'ìŠ¤ì¹´ì¼ëŸ¬' },
  { name:'ê³ ìƒí˜¸', role:'ìŠ¤ì¹´ì¼ëŸ¬' },
  { name:'ê¸°ì„¸ì¤‘', role:'ìŠ¤ì¹´ì¼ëŸ¬' },
  { name:'ì •íœ˜',   role:'ë””ë””' },
  { name:'ì´í•œì†”', role:'ë””ë””' },
  { name:'ë°•ì£¼í˜', role:'ë””ë””' },
];

// ============================================================
// COUPON / STAMP
// ============================================================
function renderCoupon() { renderStampBoards(); renderCouponList(); }

function calcStampCounts(b) {
  // í˜„ì¬: ì˜¤ëŠ˜ ë‚ ì§œê¹Œì§€ ì°íŒ ë„ì¥ ìˆ˜
  // ìµœì¢…: history ì „ì²´ í•©ì‚° (ë¯¸ë˜ í¬í•¨)
  const today = new Date().toISOString().slice(0, 10);
  let curCount = 0, finalCount = 0;
  (b.history || []).forEach(h => {
    const qty = h.qty || 1;
    finalCount += qty;
    if (h.date <= today) curCount += qty;
  });
  const total = b.totalSlots;
  return {
    cur:   Math.min(curCount,   total),
    final: Math.min(finalCount, total)
  };
}

function renderStampBoards() {
  const boards = getStampBoards();
  boards.forEach(b => recalcStampCount(b));

  const allDone = boards.length === 0 || boards.every(b => b.currentCount >= b.totalSlots);
  let html = '';

  if (allDone) {
    html += `<div style="text-align:center;padding:12px 0 8px;">
      <button class="btn btn-primary" onclick="openAddStampBoard()" style="width:100%;padding:14px;">
        ğŸ†• ìƒˆ ë„ì¥íŒ ì‹œì‘í•˜ê¸°
      </button>
      <p style="font-size:12px;color:var(--text3);margin-top:8px;">7ì¹¸ Â· 3ì¹¸:50%í• ì¸ê¶Œ Â· 7ì¹¸:ì‹¤í™©OST</p>
    </div>`;
  }

  if (boards.length === 0) {
    document.getElementById('stamp-boards-list').innerHTML = html;
    return;
  }

  const cards = boards.map(b => {
    const total      = b.totalSlots;
    const paused     = !!b.paused;
    const { cur, final } = calcStampCounts(b);
    const pct        = Math.min(100, Math.round(cur / total * 100));
    const finalPct   = Math.min(100, Math.round(final / total * 100));
    const mid3done   = cur >= 3;
    const alldone    = cur >= total;
    const markerPct  = (3 / total * 100).toFixed(2);

    const milestones = b.milestones || [{ at:3 }, { at:7 }];
    const nextMs     = [...milestones].sort((a,b2)=>a.at-b2.at).find(m => cur < m.at);
    const toNext     = nextMs ? nextMs.at - cur : null;

    let statusHtml = '';
    if (paused)               statusHtml = `<div class="stamp-status-row stamp-status-paused">ì¼ì‹œì •ì§€ ì¤‘</div>`;
    else if (alldone)         statusHtml = `<div class="stamp-status-row stamp-status-done">â˜… OST ë‹¬ì„±!</div>`;
    else if (mid3done)        statusHtml = `<div class="stamp-status-row stamp-status-mid">ğŸ· í• ì¸ê¶Œ ë‹¬ì„±!</div>`;
    else if (toNext !== null) statusHtml = `<div class="stamp-status-row stamp-status-next">ë‹¤ìŒê¹Œì§€ ${toNext}ê°œ</div>`;

    return `<div class="stamp-board${paused ? ' paused' : ''}">
      <div class="stamp-board-header">
        <div class="stamp-board-name">[ğŸ“¡ ${b.name}]</div>
        <div class="stamp-board-menu">
          <button class="stamp-menu-btn" onclick="togglePauseStampBoard('${b.id}')" title="${paused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€'}">${paused ? 'â–¶' : 'â¸'}</button>
          <button class="stamp-menu-btn danger" onclick="deleteStampBoard('${b.id}')" title="ì‚­ì œ">âœ•</button>
        </div>
      </div>
      <div class="stamp-count-row">
        <span class="stamp-count-cur">í˜„ì¬ ${cur}ì¹¸</span>
        <span class="stamp-count-final">/ ìµœì¢… ${final}ì¹¸</span>
      </div>
      <div class="stamp-progress-wrap">
        <div class="progress-bar" style="overflow:visible;">
          <div class="progress-fill" style="width:${finalPct}%;background:var(--border);border-radius:6px;"></div>
          <div class="progress-fill" style="width:${pct}%;background:${paused ? 'var(--text3)' : 'var(--accent)'};border-radius:6px;margin-top:-12px;position:relative;"></div>
          <div class="progress-marker" style="left:calc(${markerPct}% - 1px);"></div>
        </div>
      </div>
      ${statusHtml}
      <div class="stamp-actions">
        ${(!alldone && !paused) ? `<button class="btn btn-primary btn-sm" style="width:100%;" onclick="openAddStamp('${b.id}')">+ ë„ì¥ ì°ê¸°</button>` : ''}
        <button class="stamp-history-btn" onclick="openStampHistory('${b.id}')">ì´ë ¥ ë³´ê¸°</button>
      </div>
    </div>`;
  }).join('');

  html += `<div class="stamp-cards-grid">${cards}</div>`;
  document.getElementById('stamp-boards-list').innerHTML = html;
}

// ì´ë ¥ íŒ¨ë„ â€” ì„ íƒëœ ë„ì¥íŒ ì´ë ¥ì„ ê³ ì • overlayì— í‘œì‹œ
let _stampHistoryPanelBoardId = null;
function openStampHistory(boardId) {
  _stampHistoryPanelBoardId = boardId;
  renderStampHistoryPanel();
  openPanel('overlay-stamp-history');
}

function renderStampHistoryPanel() {
  const boardId = _stampHistoryPanelBoardId;
  if (!boardId) return;
  const boards = getStampBoards();
  const board  = boards.find(b => b.id === boardId);
  if (!board) return;

  document.getElementById('stamp-history-panel-title').textContent = `[ğŸ“¡ ${board.name}] ì´ë ¥`;
  const sortedHistory = [...(board.history||[])].sort((a,z) => a.date.localeCompare(z.date));
  const el = document.getElementById('stamp-history-panel-content');

  if (!sortedHistory.length) {
    el.innerHTML = '<div style="color:var(--text3);font-size:13px;padding:16px 0;text-align:center;">ì´ë ¥ ì—†ìŒ</div>';
    return;
  }
  const dow = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  el.innerHTML = '<div class="history-list">' + sortedHistory.map(h => {
    const origIdx = board.history.indexOf(h);
    const d = new Date(h.date + 'T00:00:00');
    const dateStr = `${h.date.slice(5).replace('-','.')}(${dow[d.getDay()]})`;
    const displayMethod = (h.method||'').replace(' (ìˆ˜ì •)', '');
    const qtyLabel = h.qty > 1 ? ` Ã—${h.qty}` : '';
    return `<div class="history-item">
      <div style="flex:1;">
        <div style="font-size:12px;color:var(--text2);font-weight:500;">${dateStr}</div>
        ${h.comment ? `<div class="history-comment">${h.comment}</div>` : ''}
      </div>
      <span class="history-type" style="font-size:11px;">${displayMethod}${qtyLabel}</span>
      <button class="btn-icon" style="font-size:12px;color:var(--danger);margin-left:4px;" onclick="deleteStampHistoryItemFromPanel('${boardId}',${origIdx})">âœ•</button>
    </div>`;
  }).join('') + '</div>';
}

function openAddStampHistoryDirectFromPanel() {
  if (!_stampHistoryPanelBoardId) return;
  _stampHistoryTargetId = _stampHistoryPanelBoardId;
  document.getElementById('direct-stamp-date').value = new Date().toISOString().slice(0,10);
  document.getElementById('direct-stamp-comment').value = '';
  openPanel('overlay-direct-stamp');
}

function deleteStampHistoryItemFromPanel(boardId, origIdx) {
  if (!confirm('ì´ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ë™ëœ ê´€ëŒ ê¸°ë¡ì˜ ë„ì¥íŒ ì—°ë™ë„ í•´ì œë©ë‹ˆë‹¤.')) return;
  const boards = getStampBoards();
  const board  = boards.find(b => b.id === boardId);
  if (!board || !board.history) return;
  const h = board.history[origIdx];
  board.history.splice(origIdx, 1);
  recalcStampCount(board);
  revalidateMilestones(board);
  saveStampBoards(boards);
  if (h) {
    const records = getRecords();
    const target = records.find(r => r.stampBoardId === boardId && r.date === h.date);
    if (target) { target.stampBoardId = null; saveRecords(records); }
  }
  renderStampBoards();
  renderCouponList();
  renderHome();
  renderStampHistoryPanel();
  showToast('ì´ë ¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// êµì‹ ì¼ì§€ ì´ë ¥ ì§ì ‘ ì¶”ê°€
let _stampHistoryTargetId = null;
function openAddStampHistoryDirect(boardId) {
  _stampHistoryTargetId = boardId;
  document.getElementById('direct-stamp-date').value = new Date().toISOString().slice(0,10);
  document.getElementById('direct-stamp-comment').value = '';
  openPanel('overlay-direct-stamp');
}
function saveDirectStampHistory() {
  const boardId = _stampHistoryTargetId;
  const date    = document.getElementById('direct-stamp-date').value;
  const comment = document.getElementById('direct-stamp-comment').value.trim();
  if (!date) { showToast('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const boards = getStampBoards();
  const board  = boards.find(b => b.id === boardId);
  if (!board) return;
  if (!board.history) board.history = [];
  board.history.push({ date, method: 'ì§ì ‘ ì…ë ¥', comment, qty: 1 });
  recalcStampCount(board);
  let toast = 'ì´ë ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤';
  (board.milestones||[]).forEach(m => {
    if (board.currentCount >= m.at && !m.notified) {
      m.notified = true;
      toast = 'â—† ' + m.reward + ' ë‹¬ì„±!';
    }
  });
  saveStampBoards(boards);
  closePanel('overlay-direct-stamp');
  renderStampBoards();
  renderCouponList();
  renderHome();
  if (_stampHistoryPanelBoardId === boardId) renderStampHistoryPanel();
  showToast(toast);
}

// êµì‹ ì¼ì§€ ì´ë ¥ ì§ì ‘ ì‚­ì œ (ì—°ë™ recordì˜ stampBoardIdë„ í•´ì œ)
function deleteStampHistoryItem(boardId, origIdx) {
  if (!confirm('ì´ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì—°ë™ëœ ê´€ëŒ ê¸°ë¡ì˜ ë„ì¥íŒ ì—°ë™ë„ í•´ì œë©ë‹ˆë‹¤.')) return;
  const boards = getStampBoards();
  const board  = boards.find(b => b.id === boardId);
  if (!board || !board.history) return;
  const h = board.history[origIdx];
  board.history.splice(origIdx, 1);
  recalcStampCount(board);
  revalidateMilestones(board); // ì¹¸ ì¤„ì—ˆì„ ë•Œë§Œ notified ì¬ê²€ì‚¬
  saveStampBoards(boards);
  // ì—°ë™ record í•´ì œ
  if (h) {
    const records = getRecords();
    const target = records.find(r => r.stampBoardId === boardId && r.date === h.date);
    if (target) { target.stampBoardId = null; saveRecords(records); }
  }
  renderStampBoards();
  renderHome();
  showToast('ì´ë ¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function openAddStampBoard() {
  document.getElementById('stamp-name').value = '';
  openPanel('overlay-stamp');
}

function saveStampBoard() {
  const nameInput = document.getElementById('stamp-name').value.trim();
  const boards = getStampBoards();
  // ì´ë¦„ ìë™ ë¶€ì—¬: ê¸°ì¡´ ì´ë¦„ ì¤‘ ìˆ«ì ìµœëŒ“ê°’+1 (ì‚­ì œ í›„ ì¬ì¶”ê°€ ì‹œ ì¤‘ë³µ ë°©ì§€)
  const maxNum = boards.reduce((max, b) => {
    const n = parseInt(b.name);
    return (!isNaN(n) && n > max) ? n : max;
  }, 0);
  const name = nameInput || String(maxNum + 1);
  // ì¹¸ìˆ˜/ë³´ìƒ/milestones ê³ ì •
  boards.push({
    id: uuid(),
    name,
    totalSlots: 7,
    reward: 'ì‹¤í™© OST',
    milestones: [{ at: 3, reward: '50% í• ì¸ê¶Œ', couponKey: 'discount50', notified: false }],
    currentCount: 0,
    history: []
  });
  saveStampBoards(boards);
  closePanel('overlay-stamp');
  populateStampSelect(); // ê¸°ë¡ í¼ select ê°±ì‹  (T5)
  showToast('ë„ì¥íŒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
  renderStampBoards();
}

function deleteStampBoard(id) {
  if (!confirm('ì´ ë„ì¥íŒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  saveStampBoards(getStampBoards().filter(b=>b.id!==id));
  // í•´ë‹¹ ë„ì¥íŒì— ì—°ë™ëœ ê¸°ë¡ì˜ stampBoardId í•´ì œ
  const records = getRecords();
  let changed = false;
  records.forEach(r => { if (r.stampBoardId === id) { r.stampBoardId = null; changed = true; } });
  if (changed) saveRecords(records);
  showToast('ë„ì¥íŒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  renderStampBoards();
  renderCouponList();
  renderHome();
}

function togglePauseStampBoard(id) {
  const boards = getStampBoards();
  const board  = boards.find(b => b.id === id);
  if (!board) return;
  board.paused = !board.paused;
  saveStampBoards(boards);
  renderStampBoards();
  showToast(board.paused ? 'ë„ì¥íŒì´ ì¼ì‹œì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ë„ì¥íŒì´ ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function openAddStamp(boardId) {
  document.getElementById('stamp-board-id').value = boardId;
  document.querySelector('input[name="stamp-method"][value="ì§ì ‘ ê´€ëŒ"]').checked = true;
  const qtyEl = document.querySelector('input[name="stamp-qty"][value="1"]');
  if (qtyEl) qtyEl.checked = true;
  const dateEl = document.getElementById('stamp-date');
  if (dateEl) dateEl.value = new Date().toISOString().slice(0,10);
  const commentEl = document.getElementById('stamp-comment');
  if (commentEl) commentEl.value = '';
  updateQtyLabel();
  openPanel('overlay-add-stamp');
}

function updateQtyLabel() {
  const checked = document.querySelector('input[name="stamp-qty"]:checked');
  if (!checked) return;
  const qty = checked.value;
  [1,2,3].forEach(n => {
    const label = document.getElementById('qty-label-'+n);
    if (!label) return;
    const active = String(n) === qty;
    label.style.borderColor = active ? 'var(--accent)' : 'var(--border)';
    label.style.color       = active ? 'var(--accent)' : '';
    label.style.fontWeight  = active ? '700' : '';
  });
}

// ê³µí†µ ë„ì¥ ì ìš© í•¨ìˆ˜ â€” addStamp()ì™€ saveRecord() ì–‘ìª½ì—ì„œ ì‚¬ìš©
// returns: toastMsg string
// â”€â”€ ê³µí†µ: history ê¸°ë°˜ currentCount ì¬ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function recalcStampCount(board) {
  let total = 0;
  (board.history || []).forEach(h => {
    // qty í•„ë“œ ìš°ì„ , ì—†ìœ¼ë©´ methodì˜ Ã—N íŒŒì‹±, ê·¸ê²ƒë„ ì—†ìœ¼ë©´ 1
    if (h.qty != null) {
      total += h.qty;
    } else {
      const m = h.method && h.method.match(/Ã—(\d+)/);
      total += m ? parseInt(m[1]) : 1;
    }
  });
  board.currentCount = total;
  // notifiedëŠ” ì—¬ê¸°ì„œ ê±´ë“œë¦¬ì§€ ì•ŠìŒ â€” applyStamp/delete ì‹œì—ë§Œ ì¬ê²€ì‚¬
}

// ì‚­ì œ í›„ ë§ˆì¼ìŠ¤í†¤ notified ì¬ê²€ì‚¬ (ì¹¸ì´ ì¤„ì—ˆì„ ë•Œë§Œ í˜¸ì¶œ)
function revalidateMilestones(board) {
  (board.milestones || []).forEach(m => {
    if (board.currentCount < m.at) m.notified = false;
  });
}

function applyStampToBoard(boardId, qty, date, historyComment) {
  const boards = getStampBoards();
  const board  = boards.find(b => b.id === boardId);
  if (!board) return null;

  recalcStampCount(board);
  if (board.currentCount >= board.totalSlots) return 'ì´ë¯¸ ì™„ì„±ëœ ë„ì¥íŒì…ë‹ˆë‹¤';

  const remaining = board.totalSlots - board.currentCount;
  const actualQty = Math.min(qty, remaining);

  if (!board.history) board.history = [];
  const qtyLabel = actualQty > 1 ? ' Ã—' + actualQty : '';
  board.history.push({ date, method: historyComment + qtyLabel, comment: '', qty: actualQty });
  recalcStampCount(board);

  if (!board.milestones) board.milestones = [{ at:3, reward:'50% í• ì¸ê¶Œ', couponKey:'discount50', notified:false }];
  let toastMsg = 'ë„ì¥ ' + actualQty + 'ê°œ ì™„ë£Œ (' + board.currentCount + '/' + board.totalSlots + ')';
  board.milestones.forEach(m => {
    if (board.currentCount >= m.at && !m.notified) {
      m.notified = true;
      toastMsg = 'ğŸ· ' + m.reward + ' ë‹¬ì„±!';
    }
  });

  if (board.currentCount >= board.totalSlots) {
    toastMsg = 'â˜… ë„ì¥íŒ ì™„ì„±! ' + (board.reward||'');
    if (actualQty < qty) toastMsg += ' (' + (qty - actualQty) + 'ê°œ ì´ˆê³¼ë¶„ ì œì™¸)';
  }

  saveStampBoards(boards);
  return toastMsg;
}


function addStamp() {
  const boardId   = document.getElementById('stamp-board-id').value;
  const method    = document.querySelector('input[name="stamp-method"]:checked').value;
  const qtyEl     = document.querySelector('input[name="stamp-qty"]:checked');
  const qty       = qtyEl ? parseInt(qtyEl.value) || 1 : 1;
  const dateEl    = document.getElementById('stamp-date');
  const date      = dateEl && dateEl.value ? dateEl.value : new Date().toISOString().slice(0,10);

  const toastMsg = applyStampToBoard(boardId, qty, date, method);
  if (!toastMsg) return;
  closePanel('overlay-add-stamp');
  showToast(toastMsg);
  renderStampBoards();
}

// ---- COUPON ----

// í• ì¸ê¶Œì¢… â†’ ì¿ í° í‚¤ ë§¤í•‘
const DISCOUNT_COUPON_MAP = {
  '40% í• ì¸ê¶Œ':  'discount40',
  '50% í• ì¸ê¶Œ':  'discount50',
  'ì¦ë¹™ í”„ë¦¬íŒ¨ìŠ¤': 'discountPass'
};

function onDiscountTypeChange() {
  const val = document.getElementById('rec-discount-type').value;
  const warn = document.getElementById('rec-discount-warn');
  const couponKey = DISCOUNT_COUPON_MAP[val];
  if (couponKey) {
    const coupons = getCoupons();
    warn.style.display = coupons[couponKey].count <= 0 ? '' : 'none';
  } else {
    warn.style.display = 'none';
  }
}

function onRecStampBoardChange() {
  const val = document.getElementById('rec-stamp-board').value;
  const qtyGroup = document.getElementById('rec-stamp-qty-group');
  if (qtyGroup) qtyGroup.style.display = val ? '' : 'none';
  if (!val) {
    const r1 = document.querySelector('input[name="rec-stamp-qty"][value="1"]');
    if (r1) { r1.checked = true; updateRecQtyLabel(); }
  }
}

function updateRecQtyLabel() {
  const checked = document.querySelector('input[name="rec-stamp-qty"]:checked');
  if (!checked) return;
  const qty = checked.value;
  [1,2,3].forEach(n => {
    const label = document.getElementById('rec-qty-label-' + n);
    if (!label) return;
    const active = String(n) === qty;
    label.style.borderColor = active ? 'var(--accent)' : 'var(--border)';
    label.style.color       = active ? 'var(--accent)' : '';
    label.style.fontWeight  = active ? '700' : '';
  });
}

function openAddStampBoardFromRecord() {
  document.getElementById('stamp-name').value = '';
  openPanel('overlay-stamp');
}

function openAddCouponPack() {
  document.getElementById('coupon-pack-date').value = new Date().toISOString().slice(0,10);
  document.getElementById('coupon-pack-comment').value = '';
  openPanel('overlay-coupon-pack');
}

function saveCouponPack() {
  const date    = document.getElementById('coupon-pack-date').value;
  const comment = document.getElementById('coupon-pack-comment').value.trim();
  if (!date) { showToast('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const coupons = getCoupons();
  ['discount40','discount50','discountPass'].forEach(key => {
    coupons[key].count++;
    if (!coupons[key].history) coupons[key].history = [];
    coupons[key].history.push({ type:'íšë“', date, comment: comment || 'ì¿ í°íŒ© íšë“' });
  });
  saveCoupons(coupons);
  closePanel('overlay-coupon-pack');
  renderCouponList();
  renderHome();
  showToast('ì¿ í°íŒ© ì¶”ê°€ ì™„ë£Œ (3ì¢… +1)');
}

let _couponHistoryKey = '';

const COUPON_ITEMS = [
  { key:'discount40',   label:'40% í• ì¸ê¶Œ',    short:'40%' },
  { key:'discount50',   label:'50% í• ì¸ê¶Œ',    short:'50%' },
  { key:'discountPass', label:'í• ì¸ ì¦ë¹™ PASS', short:'ì¦ë¹™' }
];

// ë„ì¥ ë‹¬ì„± ë³´ìƒì„ ë„ì¥íŒ ìƒíƒœì—ì„œ ì‹¤ì‹œê°„ ê³„ì‚°
// asOf: ë‚ ì§œ ê¸°ì¤€ (ì”ì—¬=ì˜¤ëŠ˜, ìµœì¢…=ë¯¸ë˜í¬í•¨ ì „ì²´)
function calcCouponCount(key, coupons, boards, records, asOf) {
  records = records || getRecords();
  // â‘  ìˆ˜ë™ ì´ë ¥ (ì¿ í°íŒ©, ìˆ˜ë™ ì¶”ê°€/ì°¨ê°) â€” ë‚ ì§œ í•„í„° ì ìš©
  const manual = (coupons[key].history || []).reduce((sum, h) => {
    if (asOf && h.date > asOf) return sum;
    if (h.type === 'íšë“' || h.type === 'ë³µì›') return sum + (h.qty || 1);
    if (h.type === 'ì‚¬ìš©') return sum - (h.qty || 1);
    return sum;
  }, 0);
  // â‘¡ ë„ì¥íŒ milestone ë‹¬ì„±ë¶„ â€” asOf ê¸°ì¤€ìœ¼ë¡œ ë‹¬ì„± ë‚ ì§œ ì²´í¬
  const stampBonus = boards.reduce((sum, b) => {
    return sum + (b.milestones || []).filter(m => {
      if ((m.couponKey || 'discount50') !== key || !m.notified) return false;
      if (!asOf) return true;
      const achievedDate = getStampAchievedDate(b, m.at);
      return achievedDate && achievedDate <= asOf;
    }).length;
  }, 0);
  // â‘¢ ê´€ëŒ ê¸°ë¡ í• ì¸ê¶Œ ì‚¬ìš©ë¶„ â€” asOf ê¸°ì¤€ ë‚ ì§œë§Œ ì°¨ê°
  const used = records.filter(r =>
    (DISCOUNT_COUPON_MAP[r.discountType] || null) === key &&
    (!asOf || r.date <= asOf)
  ).length;
  return Math.max(0, manual + stampBonus - used);
}

// ë„ì¥íŒì—ì„œ milestone ë‹¬ì„± ë‚ ì§œ ì¶”ì¶œ (history ëˆ„ì í•©ì´ atì— ë„ë‹¬í•œ ì‹œì )
function getStampAchievedDate(board, at) {
  const sorted = [...(board.history || [])].sort((a, b) => a.date.localeCompare(b.date));
  let cumul = 0;
  for (const h of sorted) {
    cumul += (h.qty || 1);
    if (cumul >= at) return h.date;
  }
  return sorted[sorted.length - 1]?.date || '';
}

function renderCouponList() {
  const coupons = getCoupons();
  const boards  = getStampBoards();
  const records = getRecords();
  const today   = new Date().toISOString().slice(0, 10);

  // ìµœì¢… = ë‚ ì§œ ì œí•œ ì—†ì´ ì „ì²´ + ë¯¸ë‹¬ì„± milestone
  function calcFinal(key) {
    const allUsed = calcCouponCount(key, coupons, boards, records);
    const future = boards.reduce((sum, b) => {
      return sum + (b.milestones || []).filter(m =>
        (m.couponKey || 'discount50') === key && !m.notified
      ).length;
    }, 0);
    return allUsed + future;
  }

  const cardsHtml = `<div class="coupon-cards">${COUPON_ITEMS.map(item => {
    const cur   = calcCouponCount(item.key, coupons, boards, records, today); // ì˜¤ëŠ˜ê¹Œì§€ ê¸°ì¤€
    const final = calcFinal(item.key);                                         // ì „ì²´ ê¸°ì¤€
    return `<div class="coupon-card">
      <div class="coupon-card-label">${item.label}</div>
      <div class="coupon-card-sub-row">
        <div class="coupon-card-sub">ì”ì—¬</div>
        <div class="coupon-card-sub">ìµœì¢…</div>
      </div>
      <div class="coupon-card-num-row">
        <div class="coupon-card-num">${cur}</div>
        <div class="coupon-card-num final">${final}</div>
      </div>
    </div>`;
  }).join('')}</div>`;

  document.getElementById('coupon-list').innerHTML = cardsHtml;
  renderCouponAllHistory();
}

function renderCouponAllHistory() {
  const coupons = getCoupons();
  const boards  = getStampBoards();
  const records = getRecords();
  const allRows = [];
  const dow = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

  // â‘  ìˆ˜ë™ ì´ë ¥ (íšë“/ì‚¬ìš© â€” ë³µì›Â·êµ¬ ë‹¬ì„± ë³´ìƒÂ·ê´€ëŒ ì—°ë™ ì‚¬ìš©ì€ í‘œì‹œ ì•ˆ í•¨)
  COUPON_ITEMS.forEach(item => {
    (coupons[item.key].history || []).forEach((h, idx) => {
      if (h.type === 'ë³µì›') return;
      if (h.comment && (h.comment.includes('ë‹¬ì„± ë³´ìƒ') || h.comment.includes('ì¹¸ ë‹¬ì„±'))) return;
      if (h.type === 'ì‚¬ìš©' && h.comment && h.comment.includes('ê´€ëŒ ì‚¬ìš©')) return;
      allRows.push({ ...h, key: item.key, short: item.short, originalIdx: idx, rowType: 'manual' });
    });
  });

  // â‘¡ ë„ì¥ ë‹¬ì„± ë³´ìƒ â€” ë„ì¥íŒ notified ìƒíƒœì—ì„œ ë™ì  ìƒì„± (ì‚­ì œ ë¶ˆê°€)
  boards.forEach(b => {
    (b.milestones || []).forEach(m => {
      if (!m.notified) return;
      const key = m.couponKey || 'discount50';
      const item = COUPON_ITEMS.find(i => i.key === key);
      if (!item) return;
      const date = getStampAchievedDate(b, m.at);
      allRows.push({
        date, type: 'íšë“', key, short: item.short,
        comment: `[ğŸ“¡ ${b.name}] ${m.at}ì¹¸ ë‹¬ì„±`,
        isMilestone: true, qty: 1, originalIdx: -1, rowType: 'milestone'
      });
    });
  });

  // â‘¢ ê´€ëŒ ê¸°ë¡ í• ì¸ê¶Œ ì‚¬ìš©ë¶„ â€” recordsì—ì„œ ë™ì  ìƒì„± (ì‚­ì œ ë¶ˆê°€)
  records.forEach(r => {
    const key = DISCOUNT_COUPON_MAP[r.discountType] || null;
    if (!key) return;
    const item = COUPON_ITEMS.find(i => i.key === key);
    if (!item) return;
    allRows.push({
      date: r.date, type: 'ì‚¬ìš©', key, short: item.short,
      comment: `${r.skylar}Ã—${r.didi} ê´€ëŒ`,
      qty: 1, originalIdx: -1, rowType: 'record'
    });
  });

  allRows.sort((a, b) => a.date.localeCompare(b.date));

  const el = document.getElementById('coupon-all-history');
  if (!el) return;
  if (!allRows.length) {
    el.innerHTML = '<div style="color:var(--text3);font-size:13px;padding:12px;text-align:center;">ì´ë ¥ ì—†ìŒ</div>';
    return;
  }

  const rows = allRows.map(h => {
    const d = new Date(h.date + 'T00:00:00');
    const dateStr = `${parseInt(h.date.slice(5,7))}.${parseInt(h.date.slice(8,10))}(${dow[d.getDay()]})`;
    const isGet = h.type === 'íšë“';
    const typeHtml = isGet
      ? `<span class="hist-type-get">íšë“</span>`
      : `<span class="hist-type-use">ì‚¬ìš©</span>`;
    const qty   = h.qty || 1;
    const delta = isGet ? `<span class="hist-delta-pos">+${qty}</span>` : `<span class="hist-delta-neg">-${qty}</span>`;
    const d40   = h.key === 'discount40'   ? delta : '';
    const d50   = h.key === 'discount50'   ? delta : '';
    const dPas  = h.key === 'discountPass' ? delta : '';
    const milestoneBadge = h.isMilestone ? `<span class="hist-milestone-badge">ë‹¬ì„±</span>` : '';
    const memo  = `${h.comment || ''}${milestoneBadge}`;
    const delBtn = h.rowType === 'manual'
      ? `<button class="hist-del-btn" onclick="deleteCouponHistoryRow('${h.key}',${h.originalIdx})">âœ•</button>`
      : '';
    return `<tr>
      <td style="text-align:left;white-space:nowrap;">${dateStr}</td>
      <td>${typeHtml}</td>
      <td>${d40}</td><td>${d50}</td><td>${dPas}</td>
      <td style="text-align:left;color:var(--text2);font-size:11px;">${memo}</td>
      <td>${delBtn}</td>
    </tr>`;
  }).join('');

  el.innerHTML = `<table class="coupon-hist-table">
    <thead><tr>
      <th style="text-align:center;">ë‚ ì§œ</th><th>ìœ í˜•</th><th>40%</th><th>50%</th><th>ì¦ë¹™</th><th style="text-align:center;">ë©”ëª¨</th><th></th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

function deleteCouponHistoryRow(key, originalIdx) {
  if (!confirm('ì´ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const coupons = getCoupons();
  coupons[key].history.splice(originalIdx, 1);
  // countëŠ” renderCouponListì—ì„œ calcCouponCountë¡œ ì‹¤ì‹œê°„ ê³„ì‚°í•˜ë¯€ë¡œ ë³„ë„ ì €ì¥ ë¶ˆí•„ìš”
  // í•˜ì§€ë§Œ getCoupons()ì˜ count í•„ë“œë„ ë§ì¶°ë‘ 
  const boards = getStampBoards();
  coupons[key].count = calcCouponCount(key, coupons, boards);
  saveCoupons(coupons);
  renderCouponList();
  renderHome();
  showToast('ì´ë ¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function openAddCouponManual() {
  document.getElementById('manual-coupon-key').value = 'discount40';
  document.querySelector('input[name="manual-coupon-type"][value="íšë“"]').checked = true;
  document.querySelector('input[name="manual-coupon-qty"][value="1"]').checked = true;
  document.getElementById('manual-coupon-date').value = new Date().toISOString().slice(0,10);
  document.getElementById('manual-coupon-comment').value = '';
  updateManualTypeLabel();
  updateManualQtyLabel();
  openPanel('overlay-coupon-manual');
}

function updateManualTypeLabel() {
  const val = document.querySelector('input[name="manual-coupon-type"]:checked')?.value;
  ['íšë“','ì‚¬ìš©','ë³µì›'].forEach(v => {
    const el = document.getElementById('manual-type-label-'+v);
    if (!el) return;
    const active = v === val;
    el.style.borderColor = active ? 'var(--accent)' : 'var(--border)';
    el.style.color       = active ? 'var(--accent)' : '';
    el.style.fontWeight  = active ? '700' : '';
  });
}

function updateManualQtyLabel() {
  const val = document.querySelector('input[name="manual-coupon-qty"]:checked')?.value;
  [1,2,3].forEach(n => {
    const el = document.getElementById('manual-qty-label-'+n);
    if (!el) return;
    const active = String(n) === val;
    el.style.borderColor = active ? 'var(--accent)' : 'var(--border)';
    el.style.color       = active ? 'var(--accent)' : '';
    el.style.fontWeight  = active ? '700' : '';
  });
}

function saveManualCoupon() {
  const key     = document.getElementById('manual-coupon-key').value;
  const type    = document.querySelector('input[name="manual-coupon-type"]:checked').value;
  const qty     = parseInt(document.querySelector('input[name="manual-coupon-qty"]:checked').value) || 1;
  const date    = document.getElementById('manual-coupon-date').value;
  const comment = document.getElementById('manual-coupon-comment').value.trim();
  if (!date) { showToast('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  const coupons = getCoupons();
  if (!coupons[key].history) coupons[key].history = [];
  coupons[key].history.push({ type, date, comment: comment || type, qty });
  if (type === 'íšë“' || type === 'ë³µì›') coupons[key].count += qty;
  if (type === 'ì‚¬ìš©') coupons[key].count = Math.max(0, coupons[key].count - qty);

  saveCoupons(coupons);
  closePanel('overlay-coupon-manual');
  renderCouponList();
  renderHome();
  showToast(`${COUPON_ITEMS.find(i=>i.key===key)?.label} ${type} ${qty}ê°œ ì™„ë£Œ`);
}

// ============================================================
// SETTINGS
// ============================================================
function toggleDark() {
  const s = getSettings(); s.darkMode=!s.darkMode; saveSettings(s); applyDark(s.darkMode);
}
function applyDark(on) {
  document.documentElement.setAttribute('data-theme', on?'dark':'light');
  const btn = document.getElementById('dark-toggle');
  if (on) btn.classList.add('on'); else btn.classList.remove('on');
}

function exportData() {
  const data = {
    records:     getRecords(),
    schedule:    getSchedule(),
    events:      getEvents(),
    stampBoards: getStampBoards(),
    coupons:     getCoupons(),
    settings:    getSettings()
  };
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
  a.download = `roger_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  showToast('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.records)     saveRecords(data.records);
      if (data.schedule)    saveSchedule(data.schedule);
      if (data.events)      saveEvents(data.events);
      if (data.stampBoards) saveStampBoards(data.stampBoards);
      if (data.coupons)     saveCoupons(data.coupons);
      if (data.settings)  { saveSettings(data.settings); applyDark(data.settings.darkMode); }
      showToast('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
      renderHome();
    } catch { showToast('íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// ============================================================
// REFRESH
// ============================================================
function refreshCurrentPage() {
  const id = document.querySelector('.page.active')?.id;
  if (id==='page-home')     renderHome();
  if (id==='page-calendar') renderCalendar();
  if (id==='page-stats')    renderStats();
  if (id==='page-coupon')   renderCoupon();
}

// ============================================================
// INIT
// ============================================================
function migrateData() {
  // êµ¬ ë°ì´í„° í˜¸í™˜: historyì— ì €ì¥ëœ ë‹¬ì„± ë³´ìƒ / ë³µì› / ê´€ëŒ ì—°ë™ ì‚¬ìš© í•­ëª© ì œê±°
  // (notified ê¸°ë°˜ ë™ì  ìƒì„± + records ê¸°ë°˜ ë™ì  ìƒì„± ë°©ì‹ìœ¼ë¡œ ì „í™˜ëìœ¼ë¯€ë¡œ ì¤‘ë³µ ë°©ì§€)
  const coupons = getCoupons();
  let changed = false;
  ['discount40','discount50','discountPass'].forEach(key => {
    if (!coupons[key]?.history) return;
    const before = coupons[key].history.length;
    coupons[key].history = coupons[key].history.filter(h => {
      if (h.type === 'ë³µì›') return false;
      if (h.comment && (h.comment.includes('ë‹¬ì„± ë³´ìƒ') || h.comment.includes('ì¹¸ ë‹¬ì„±'))) return false;
      // ê´€ëŒ ì—°ë™ìœ¼ë¡œ ìë™ ìƒì„±ëœ ì‚¬ìš© í•­ëª© (ì˜ˆ: "ê³ ìƒí˜¸Ã—ì´í•œì†” ê´€ëŒ ì‚¬ìš©")
      if (h.type === 'ì‚¬ìš©' && h.comment && h.comment.includes('ê´€ëŒ ì‚¬ìš©')) return false;
      return true;
    });
    if (coupons[key].history.length !== before) changed = true;
  });
  if (changed) saveCoupons(coupons);
}

function init() {
  const s = getSettings();
  applyDark(s.darkMode);
  migrateData();
  initCal();
  renderHome();

  // ìŠ¤ì¼€ì¤„ ìë™ fetch (ì˜¨ë¼ì¸ì´ë©´ ìµœì‹ , ì˜¤í”„ë¼ì¸ì´ë©´ ìºì‹œ)
  fetchSchedule(false);
  fetchEvents(false);

  // Service Worker ë“±ë¡
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('SW registered'))
      .catch(e => console.log('SW failed:', e));
  }

  // ì„¤ì • íƒ­ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
  const savedAt = localStorage.getItem('scheduleUpdatedAt');
  const timeEl  = document.getElementById('schedule-update-time');
  if (timeEl && savedAt) timeEl.textContent = savedAt + ' (ìºì‹œ)';
}
init();
</script>
</body>
</html>
